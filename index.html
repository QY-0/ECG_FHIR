<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FHIR ECG ÁÆ°ÁêÜÁ≥ªÁµ±</title>
    
    <!-- Favicon ÂúñÁ§∫ -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>üè•</text></svg>">
    
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', 'Segoe UI', 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        /* ÈüøÊáâÂºèË®≠Ë®à */
        @media (max-width: 768px) {
            body {
                padding: 10px;
            }
            
            h1 {
                font-size: 2em;
                margin-bottom: 25px;
            }
            
            .card {
                padding: 20px;
                border-radius: 16px;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            .button-group button {
                min-width: 100%;
            }
            
            canvas {
                max-width: 100%;
                height: auto !important;
            }
            
            #ann-stats-content {
                grid-template-columns: 1fr !important;
            }
        }

        @media (max-width: 480px) {
            h1 {
                font-size: 1.5em;
            }
            
            button {
                font-size: 14px;
                padding: 10px 18px;
            }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(255,255,255,0.05) 0%, transparent 50%),
                radial-gradient(circle at 80% 80%, rgba(255,255,255,0.05) 0%, transparent 50%);
            pointer-events: none;
            z-index: 0;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        h1 {
            text-align: center;
            color: white;
            margin-bottom: 45px;
            font-size: 3em;
            font-weight: 800;
            text-shadow: 0 5px 15px rgba(0,0,0,0.3), 0 2px 5px rgba(0,0,0,0.2);
            letter-spacing: 2px;
            animation: fadeIn 0.8s ease-out;
            position: relative;
            padding-bottom: 20px;
        }

        h1::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 4px;
            background: linear-gradient(90deg, transparent, white, transparent);
            border-radius: 2px;
        }

        .card {
            background: rgba(255, 255, 255, 0.98);
            border-radius: 24px;
            padding: 40px;
            margin-bottom: 30px;
            box-shadow: 
                0 20px 50px rgba(0,0,0,0.12),
                0 8px 20px rgba(0,0,0,0.08),
                inset 0 1px 0 rgba(255,255,255,0.9);
            animation: fadeIn 0.7s ease-out;
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255,255,255,0.3);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .card::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .card:hover::before {
            left: 100%;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 
                0 25px 60px rgba(0,0,0,0.15),
                0 10px 25px rgba(0,0,0,0.1),
                inset 0 1px 0 rgba(255,255,255,0.9);
        }
        
        .section {
            display: none;
        }
        
        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes slideInRight {
            from {
                opacity: 0;
                transform: translateX(50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes slideInLeft {
            from {
                opacity: 0;
                transform: translateX(-50px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        @keyframes scaleIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
        }

        @keyframes shimmer {
            0% {
                background-position: -1000px 0;
            }
            100% {
                background-position: 1000px 0;
            }
        }

        /* Êñ∞ÊâãÂºïÂ∞éÊ®£Âºè */
        .tutorial-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            z-index: 9999;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 0.3s ease;
        }

        .tutorial-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            max-width: 600px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
            animation: scaleIn 0.4s ease;
            max-height: 80vh;
            overflow-y: auto;
        }

        .tutorial-box h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 1.8em;
        }

        .tutorial-box ul {
            list-style: none;
            padding: 0;
        }

        .tutorial-box li {
            padding: 12px 0;
            border-bottom: 1px solid #eee;
            font-size: 1.05em;
            line-height: 1.6;
        }

        .tutorial-box li:last-child {
            border-bottom: none;
        }

        .tutorial-box .shortcut {
            display: inline-block;
            background: #f0f0f0;
            padding: 4px 10px;
            border-radius: 6px;
            font-weight: bold;
            color: #667eea;
            margin: 0 5px;
            font-family: 'Courier New', monospace;
        }

        /* Âè≥ÈçµÈÅ∏ÂñÆ */
        .context-menu {
            position: fixed;
            background: white;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            padding: 8px 0;
            z-index: 10000;
            min-width: 180px;
            animation: scaleIn 0.15s ease;
        }

        .context-menu-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .context-menu-item:hover {
            background: #f0f0f0;
        }

        .context-menu-item.danger:hover {
            background: #ffebee;
            color: #d32f2f;
        }

        /* Âø´Êç∑ÈçµÊèêÁ§∫ */
        .shortcut-hint {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            font-size: 14px;
            max-width: 300px;
            animation: slideInRight 0.4s ease;
        }

        .shortcut-hint h4 {
            margin: 0 0 10px 0;
            color: #667eea;
            font-size: 1.1em;
        }

        .shortcut-hint p {
            margin: 5px 0;
            color: #666;
        }

        .card h2 {
            color: #667eea;
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 3px solid transparent;
            background: linear-gradient(to right, #667eea 0%, #764ba2 100%);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            position: relative;
            font-weight: 700;
            font-size: 1.8em;
        }

        .card h2::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 80px;
            height: 3px;
            background: linear-gradient(to right, #667eea, #764ba2);
            border-radius: 2px;
        }

        .form-group {
            margin-bottom: 25px;
            animation: slideInLeft 0.5s ease-out;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
            animation: slideInRight 0.5s ease-out;
        }

        label {
            display: block;
            margin-bottom: 10px;
            color: #444;
            font-weight: 600;
            font-size: 15px;
            letter-spacing: 0.3px;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e8e8e8;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            background: #fafafa;
        }

        input:hover, select:hover {
            border-color: #d0d0d0;
            background: #fff;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.12);
            background: #fff;
            transform: translateY(-1px);
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 14px 32px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            width: 100%;
            margin-top: 10px;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            position: relative;
            overflow: hidden;
        }

        button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: skewX(-20deg);
            transition: left 0.5s ease;
        }

        button:hover::before {
            left: 100%;
        }

        button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.5);
        }

        button:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 20px rgba(245, 87, 108, 0.5);
        }

        #output {
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 500px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.6;
        }

        .success {
            color: #28a745;
            font-weight: 700;
            padding: 12px 20px;
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            border-radius: 10px;
            border-left: 4px solid #28a745;
            margin: 10px 0;
            animation: slideInRight 0.5s ease-out;
        }

        .error {
            color: #dc3545;
            font-weight: 700;
            padding: 12px 20px;
            background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
            border-radius: 10px;
            border-left: 4px solid #dc3545;
            margin: 10px 0;
            animation: slideInRight 0.5s ease-out;
        }

        .info {
            color: #17a2b8;
            font-weight: 700;
            padding: 12px 20px;
            background: linear-gradient(135deg, #d1ecf1 0%, #bee5eb 100%);
            border-radius: 10px;
            border-left: 4px solid #17a2b8;
            margin: 10px 0;
            animation: slideInRight 0.5s ease-out;
        }

        footer {
            text-align: center;
            color: white;
            margin-top: 40px;
            padding: 25px;
            background: rgba(255,255,255,0.12);
            border-radius: 15px;
            backdrop-filter: blur(15px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border: 1px solid rgba(255,255,255,0.2);
            font-size: 14px;
        }

        /* ECG Canvas Ê®£Âºè */
        .ecg-canvas-container {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 24px;
            padding: 35px;
            margin: 35px 0;
            box-shadow: 
                0 15px 45px rgba(0,0,0,0.08),
                inset 0 2px 0 rgba(255,255,255,0.95),
                inset 0 -2px 0 rgba(0,0,0,0.05);
            border: 2px solid rgba(255,255,255,0.6);
            position: relative;
            overflow: hidden;
        }

        .ecg-canvas-container::before {
            content: '';
            position: absolute;
            top: -2px;
            left: -2px;
            right: -2px;
            height: 2px;
            background: linear-gradient(90deg, #667eea, #764ba2, #667eea);
            background-size: 200% 100%;
            animation: shimmer 3s linear infinite;
        }

        canvas {
            border: 3px solid #667eea;
            border-radius: 12px;
            background: white;
            box-shadow: 
                0 8px 25px rgba(0,0,0,0.12),
                inset 0 1px 0 rgba(255,255,255,0.8);
            display: block;
            margin: 20px auto;
            max-width: 100%;
            transition: transform 0.3s ease;
        }

        canvas:hover {
            transform: translateY(-2px);
            box-shadow: 
                0 12px 35px rgba(0,0,0,0.15),
                inset 0 1px 0 rgba(255,255,255,0.8);
        }

        #progress-container {
            margin: 30px 0;
            position: relative;
            height: 55px;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 15px;
            padding: 12px;
            box-shadow: 
                0 4px 15px rgba(0,0,0,0.08),
                inset 0 2px 4px rgba(0,0,0,0.05);
            border: 2px solid rgba(102, 126, 234, 0.1);
        }

        #progress-bar {
            position: absolute;
            height: 14px;
            width: calc(100% - 24px);
            background: linear-gradient(90deg, #e8e8e8 0%, #f5f5f5 100%);
            cursor: pointer;
            border-radius: 8px;
            top: 20px;
            left: 12px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        #progress-handle {
            position: absolute;
            height: 34px;
            width: 18px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: grab;
            margin-top: -11px;
            border-radius: 6px;
            box-shadow: 
                0 4px 12px rgba(102, 126, 234, 0.4),
                inset 0 1px 0 rgba(255,255,255,0.3);
            transition: all 0.2s ease;
            border: 2px solid rgba(255,255,255,0.5);
        }

        #progress-handle:hover {
            transform: scale(1.15);
            box-shadow: 
                0 6px 18px rgba(102, 126, 234, 0.6),
                inset 0 1px 0 rgba(255,255,255,0.3);
        }

        #progress-handle:active {
            cursor: grabbing;
            transform: scale(1.05);
        }

        .y-offset-container {
            background: linear-gradient(135deg, #ffffff 0%, #fafafa 100%);
            padding: 18px 20px;
            margin: 15px 0;
            border-radius: 12px;
            display: flex;
            align-items: center;
            gap: 18px;
            box-shadow: 0 3px 12px rgba(0,0,0,0.08);
            border: 1px solid #f0f0f0;
            transition: all 0.3s ease;
        }

        .y-offset-container:hover {
            box-shadow: 0 5px 18px rgba(0,0,0,0.12);
            transform: translateY(-2px);
        }

        .y-offset-container label {
            font-weight: 600;
            color: #333;
            min-width: 140px;
        }

        .y-offset-container input[type="range"] {
            flex: 1;
            min-width: 300px;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(90deg, #e0e0e0 0%, #f0f0f0 100%);
            outline: none;
            -webkit-appearance: none;
        }

        .y-offset-container input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.4);
            transition: all 0.2s ease;
        }

        .y-offset-container input[type="range"]::-webkit-slider-thumb:hover {
            transform: scale(1.2);
            box-shadow: 0 3px 12px rgba(102, 126, 234, 0.6);
        }

        .y-offset-container span {
            min-width: 40px;
            text-align: center;
            font-weight: 600;
            color: #667eea;
        }

        .y-offset-container button {
            min-width: 28px;
            height: 28px;
            border-radius: 50%;
            font-size: 0.8em;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 6px rgba(102, 126, 234, 0.3);
        }

        .y-offset-container button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.5);
        }

        .y-offset-container button.inactive {
            opacity: 0.4;
        }

        #buttons {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 25px 0;
            justify-content: center;
            padding: 20px;
            background: rgba(255,255,255,0.5);
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .marker-btn {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #667eea;
            color: #667eea;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.12);
            min-width: 60px;
            max-width: 80px;
            position: relative;
            overflow: visible;
            white-space: nowrap;
        }

        .marker-btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.1);
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }

        .marker-btn:hover::before {
            width: 150px;
            height: 150px;
        }

        .marker-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px) scale(1.03);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.35);
            border-color: transparent;
        }

        .marker-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 6px 18px rgba(102, 126, 234, 0.5);
            border-color: transparent;
            transform: scale(1.05);
        }

        .query-type-btn {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 3px solid #e0e0e0;
            color: #666;
            padding: 20px 15px;
            border-radius: 12px;
            cursor: pointer;
            font-weight: 500;
            font-size: 1em;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.08);
            position: relative;
            overflow: hidden;
            text-align: center;
            width: 100%;
        }

        .query-type-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(102, 126, 234, 0.1), transparent);
            transition: left 0.5s ease;
        }

        .query-type-btn:hover::before {
            left: 100%;
        }

        .query-type-btn:hover {
            border-color: #667eea;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(102, 126, 234, 0.2);
            color: #667eea;
        }

        .query-type-btn.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-color: transparent;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
            transform: translateY(-2px);
        }

        .query-type-btn.active:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.5);
        }

        .info-box {
            background: linear-gradient(135deg, #e3f2fd 0%, #f0f7ff 100%);
            border-left: 5px solid #2196f3;
            padding: 20px;
            margin: 20px 0;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(33, 150, 243, 0.1);
            border: 1px solid rgba(33, 150, 243, 0.2);
        }

        .button-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .button-group button {
            flex: 1;
            min-width: 180px;
            animation: scaleIn 0.5s ease-out;
            animation-fill-mode: backwards;
        }

        .button-group button:nth-child(1) {
            animation-delay: 0.1s;
        }

        .button-group button:nth-child(2) {
            animation-delay: 0.2s;
        }

        .button-group button:nth-child(3) {
            animation-delay: 0.3s;
        }

        #segment {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            padding: 25px;
            margin: 25px 0;
            border-radius: 18px;
            border: 2px solid #e8e8e8;
            line-height: 2.2;
            box-shadow: 0 6px 20px rgba(0,0,0,0.06);
            transition: all 0.3s ease;
        }

        #segment:hover {
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        #segment p {
            margin: 15px 0;
            font-weight: 500;
        }

        #ann-statistics {
            animation: fadeIn 0.6s ease-out;
        }

        #ann-statistics h3 {
            font-size: 1.5em;
            font-weight: 700;
            margin-bottom: 20px;
        }

        #segment button {
            width: auto;
            padding: 8px 16px;
            margin: 0 5px;
            font-size: 14px;
        }

        #segment select {
            width: auto;
            padding: 6px 10px;
            margin: 0 5px;
            display: inline-block;
        }

        .upload-section {
            background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.05);
            border: 2px dashed #dee2e6;
            transition: all 0.3s ease;
        }

        .upload-section:hover {
            border-color: #667eea;
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.15);
        }

        .upload-section h1 {
            color: #333;
            text-align: left;
            text-shadow: none;
            margin-bottom: 20px;
            font-size: 1.6em;
            animation: none;
        }

        .upload-section h1::after {
            display: none;
        }

        .upload-section p {
            margin: 15px 0;
            color: #555;
            font-weight: 500;
        }

        .ann-actions button {
            width: auto;
            padding: 10px 20px;
            margin: 0 5px;
            font-size: 14px;
        }

        input[type="file"] {
            padding: 12px;
            border: 2px dashed #667eea;
            border-radius: 10px;
            background: rgba(102, 126, 234, 0.05);
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        input[type="file"]:hover {
            border-color: #764ba2;
            background: rgba(102, 126, 234, 0.1);
            transform: translateY(-2px);
        }

        /* ËºâÂÖ•ÂãïÁï´ */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* ÊàêÂäüÊâìÂãæÂãïÁï´ */
        .checkmark {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #28a745;
            position: relative;
            animation: scaleIn 0.3s ease-out;
        }

        .checkmark::after {
            content: '';
            position: absolute;
            left: 7px;
            top: 3px;
            width: 5px;
            height: 10px;
            border: solid white;
            border-width: 0 2px 2px 0;
            transform: rotate(45deg);
        }

        @media (max-width: 768px) {
            .form-row {
                grid-template-columns: 1fr;
            }
            
            h1 {
                font-size: 2em;
                margin-bottom: 30px;
            }
            
            .card {
                padding: 25px;
                border-radius: 18px;
            }
            
            .button-group button {
                min-width: 100%;
            }
            
            canvas {
                width: 100% !important;
                height: auto !important;
            }
            
            #buttons {
                gap: 10px;
            }
            
            .marker-btn {
                min-width: 70px;
                max-width: 100px;
                padding: 10px 20px;
                font-size: 1em;
            }
        }
    </style>
</head>
<body>
    <!-- Âø´Êç∑ÂäüËÉΩÊåâÈàïÁµÑ -->
    <div style="position: fixed; top: 20px; right: 20px; z-index: 1000; display: flex; gap: 10px;">
        <button onclick="toggleShortcutHint()" style="background: rgba(255,255,255,0.95); border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 16px; transition: all 0.3s ease;" title="Âø´Êç∑ÈçµÊèêÁ§∫">
            ‚å®Ô∏è
        </button>
        <button onclick="showTutorial()" style="background: rgba(255,255,255,0.95); border: none; padding: 10px 15px; border-radius: 8px; cursor: pointer; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-size: 16px; transition: all 0.3s ease;" title="Êñ∞ÊâãÊïôÂ≠∏">
            ‚ùì
        </button>
    </div>

    <div class="container">
        <h1>üè• FHIR ECG ÁÆ°ÁêÜÁ≥ªÁµ±</h1>

        <!-- ÂàùÂßãÈÅ∏Êìá -->
        <div class="card section active" id="initial-section">
            <h2>üè† Ê≠°Ëøé‰ΩøÁî® ECG FHIR Á≥ªÁµ±</h2>
            <p style="text-align: center; color: #666; margin-bottom: 20px;">Ë´ãÈÅ∏ÊìáÊÇ®ÁöÑÊìç‰ΩúÈ°ûÂûã</p>
            <div class="button-group">
                <button class="btn-primary" onclick="showNewPatient()">‚ûï Âª∫Á´ãÊñ∞ÁóÖÊÇ£</button>
                <button class="btn-primary" onclick="showExistingPatient()">üë§ ‰ΩøÁî®Â∑≤ÊúâÁóÖÊÇ£</button>
                <button class="btn-secondary" onclick="showQueryPage()">üîç Êü•Ë©¢Ë≥áÊñô</button>
            </div>
        </div>

        <!-- Â∑≤ÊúâÁóÖÊÇ£ÈÅ∏Êìá -->
        <div class="card section" id="existing-patient-section">
            <h2>üë§ Â∑≤ÊúâÁóÖÊÇ£Êìç‰Ωú</h2>
            <div class="form-group">
                <label for="existing-patient-id">Ë´ãËº∏ÂÖ• Patient ID *</label>
                <input type="text" id="existing-patient-id" placeholder="‰æãÂ¶Ç: 12345">
            </div>
            <div class="button-group">
                <button class="btn-primary" onclick="verifyAndShowOptions()">‚úì È©óË≠â‰∏¶ÁπºÁ∫å</button>
                <button class="btn-secondary" onclick="showInitial()">ËøîÂõû</button>
            </div>
            <div id="patient-verification" style="display:none; margin-top: 20px;">
                <div class="info-box">
                    <h3>‚úÖ ÁóÖÊÇ£Ë≥áÊñôÂ∑≤È©óË≠â</h3>
                    <div id="patient-info"></div>
                </div>
                <h3 style="margin-top: 20px;">Ë´ãÈÅ∏ÊìáÊìç‰ΩúÔºö</h3>
                <div class="button-group">
                    <button class="btn-primary" onclick="showObservationList()">üìã Êü•ÁúãÊ≠§ÁóÖÊÇ£ÁöÑÊâÄÊúâ ECG</button>
                    <button class="btn-primary" onclick="showECGUpload()">üì§ ‰∏äÂÇ≥Êñ∞ ECG</button>
                </div>
            </div>
        </div>

        <!-- Observation ÂàóË°® -->
        <div class="card section" id="observation-list-section">
            <h2>üìã ECG Ë®òÈåÑÂàóË°®</h2>
            <div id="observation-list-content">
                <p class="info">ËºâÂÖ•‰∏≠...</p>
            </div>
            <div class="button-group" style="margin-top: 20px;">
                <button class="btn-primary" onclick="showECGUpload()">üì§ ‰∏äÂÇ≥Êñ∞ ECG</button>
                <button class="btn-secondary" onclick="showExistingPatient()">ËøîÂõû</button>
            </div>
        </div>

        <!-- ÁóÖÊÇ£Ë≥áÊñôËº∏ÂÖ• -->
        <div class="card section" id="patient-section">
            <h2>üìù Âª∫Á´ãÊñ∞ÁóÖÊÇ£Ë≥áÊñô</h2>
            <form id="patientForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="family">ÂßìÊ∞è (Family Name) *</label>
                        <input type="text" id="family" placeholder="‰æãÂ¶Ç: Wang" required>
                    </div>
                    <div class="form-group">
                        <label for="given">ÂêçÂ≠ó (Given Name) *</label>
                        <input type="text" id="given" placeholder="‰æãÂ¶Ç: Xiao Ming" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="gender">ÊÄßÂà• (Gender) *</label>
                        <select id="gender" required>
                            <option value="">Ë´ãÈÅ∏Êìá</option>
                            <option value="male">Áî∑ÊÄß (Male)</option>
                            <option value="female">Â•≥ÊÄß (Female)</option>
                            <option value="other">ÂÖ∂‰ªñ (Other)</option>
                            <option value="unknown">Êú™Áü• (Unknown)</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="birthDate">ÁîüÊó• (Birth Date) *</label>
                        <input type="date" id="birthDate" required>
                    </div>
                </div>

                <div class="form-group">
                    <label for="phone">ÈõªË©± (Phone)</label>
                    <input type="tel" id="phone" placeholder="‰æãÂ¶Ç: 0912-345678">
                </div>

                <div class="button-group">
                    <button type="submit">üöÄ Âª∫Á´ã‰∏¶‰∏äÂÇ≥Âà∞ FHIR Server</button>
                    <button type="button" class="btn-secondary" onclick="showInitial()">ËøîÂõû</button>
                </div>
            </form>
            
            <div id="patient-output" style="display:none; margin-top: 20px;">
                <h3>Âª∫Á´ãÁµêÊûú</h3>
                <div id="output" class="info-box"></div>
            </div>
        </div>

        <!-- Êü•Ë©¢È†ÅÈù¢ -->
        <div class="card section" id="query-section">
            <h2>üîç Êü•Ë©¢Ë≥áÊñô</h2>
            <p style="color: #666; margin-bottom: 20px;">ÂèØÊü•Ë©¢ Patient Êàñ Observation Ë≥áÊñô</p>
            
            <!-- Êü•Ë©¢È°ûÂûãÈÅ∏Êìá -->
            <div style="background: linear-gradient(135deg, #f8f9fa 0%, #ffffff 100%); padding: 25px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.08); border: 2px solid rgba(102, 126, 234, 0.1);">
                <label style="margin-bottom: 15px; display: block; font-weight: 600; font-size: 1.1em; color: #333;">üìÇ ÈÅ∏ÊìáÊü•Ë©¢È°ûÂûã</label>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <button id="query-type-patient" class="query-type-btn active" onclick="selectQueryType('patient')">
                        <span style="font-size: 1.5em; display: block; margin-bottom: 5px;">üë§</span>
                        <span style="font-weight: 600; font-size: 1.1em;">Patient</span>
                        <span style="font-size: 0.85em; opacity: 0.8; display: block; margin-top: 3px;">ÁóÖÊÇ£Ë≥áÊñô</span>
                    </button>
                    <button id="query-type-observation" class="query-type-btn" onclick="selectQueryType('observation')">
                        <span style="font-size: 1.5em; display: block; margin-bottom: 5px;">üìä</span>
                        <span style="font-weight: 600; font-size: 1.1em;">Observation</span>
                        <span style="font-size: 0.85em; opacity: 0.8; display: block; margin-top: 3px;">Ê™¢Êü•Ë®òÈåÑ</span>
                    </button>
                </div>
            </div>
            
            <!-- Patient Êü•Ë©¢ -->
            <div id="query-patient-area" style="display: block;">
                <div class="form-group">
                    <label for="queryPatientId">Patient ID *</label>
                    <input type="text" id="queryPatientId" placeholder="Ëº∏ÂÖ• Patient ID (‰æãÂ¶Ç: 12345)">
                </div>
                <button class="btn-primary" onclick="getPatient()">üîé Êü•Ë©¢ Patient Ë≥áÊñô</button>
            </div>
            
            <!-- Observation Êü•Ë©¢ -->
            <div id="query-observation-area" style="display: none;">
                <div class="form-group">
                    <label for="queryObservationId">Observation ID *</label>
                    <input type="text" id="queryObservationId" placeholder="Ëº∏ÂÖ• Observation ID (‰æãÂ¶Ç: 67890)">
                </div>
                <button class="btn-primary" onclick="getObservation()">üîé Êü•Ë©¢ Observation Ë≥áÊñô</button>
            </div>
            
            <div class="button-group" style="margin-top: 20px;">
                <button class="btn-secondary" onclick="showInitial()">üè† ËøîÂõûÈ¶ñÈ†Å</button>
            </div>
            
            <div id="query-output" style="display:none; margin-top: 20px;">
                <h3>Êü•Ë©¢ÁµêÊûú</h3>
                <div id="query-result" class="info-box"></div>
            </div>
        </div>

        <!-- ECG ‰∏äÂÇ≥ËàáÊü•Áúã -->
        <div class="card section" id="ecg-section">
            <!-- Ê™îÊ°à‰∏äÂÇ≥ÂçÄ -->
            <div class="upload-section" style="background: #f8f9fa; padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h1 style="color: #333; font-size: 1.8em; margin: 0;">ECG ÂàÜÊûêÂ∑•ÂÖ∑</h1>
                    <button onclick="clearAllECGData()" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 14px; box-shadow: 0 4px 12px rgba(245, 87, 108, 0.3); transition: all 0.3s ease;" title="Ê∏ÖÁ©∫ÊâÄÊúâÂ∑≤ËºâÂÖ•ÁöÑ ECG Ë≥áÊñô">
                        üóëÔ∏è Ê∏ÖÁ©∫Ë≥áÊñô
                    </button>
                </div>
                <div>
                    <p style="margin-bottom: 10px;">‰∏äÂÇ≥ ECG Êï∏Êìö (.txt): 
                    <input type="file" id="ecg-file" accept=".txt"></p>
                </div>
                
                <div class="ann-actions" style="margin-top: 15px;">
                    <p>ANN Ê™îÊ°àËôïÁêÜ:
                    <button id="uploadAnnBtn" onclick="uploadANN()">‰∏äÂÇ≥ ANN Ê™îÊ°à</button>
                    <input type="file" id="ann-file" accept=".ANN.txt" style="display:none">
                    <button id="predictAnnBtn" onclick="predictANN()">Ê®°ÂûãÈ†êÊ∏¨ ANN</button>
                    <button id="downloadAnnBtn" onclick="downloadANN()">‰∏ãËºâ ANN</button>
                    </p>
                </div>
            </div>

            <!-- ECG Canvas È°ØÁ§∫ÂçÄ -->
            <div class="ecg-canvas-container" id="ecg-canvas-area" style="display:none;">
                <canvas id="dataCanvas" width="1600" height="500"></canvas>
                <canvas id="zoomCanvas" width="1600" height="150"></canvas>
                
                <div id="progress-container">
                    <div id="progress-bar"></div>
                    <div id="progress-handle"></div>
                </div>

                <div id="buttons" style="margin: 15px 0; display: flex; gap: 12px; flex-wrap: wrap; justify-content: center;">
                    <button id="btn1" class="marker-btn">N</button>
                    <button id="btn2" class="marker-btn">S</button>
                    <button id="btn3" class="marker-btn">Q</button>
                    <button id="btn4" class="marker-btn">V</button>
                    <button id="btn5" class="marker-btn">B</button>
                    <button id="btnDelete" class="marker-btn">Âà™Èô§</button>
                </div>

                <div id="y-offsets">
                    <div class="y-offset-container">
                        <label for="lead1-offset">Lead 1 Position:</label>
                        <input type="range" id="lead1-offset" min="0" max="400" step="20" value="100">
                        <span id="lead1-offset-value">100</span>
                        <button id="toggleLead1">‚úî</button> &emsp; &emsp;
                    </div>
                    <div class="y-offset-container">
                        <label for="lead2-offset">Lead 2 Position:</label>
                        <input type="range" id="lead2-offset" min="0" max="500" step="20" value="250">
                        <span id="lead2-offset-value">250</span>
                        <button id="toggleLead2">‚úî</button> &emsp; &emsp;
                    </div>
                    <div class="y-offset-container">
                        <label for="lead3-offset">Lead 3 Position:</label>
                        <input type="range" id="lead3-offset" min="200" max="600" step="20" value="400">
                        <span id="lead3-offset-value">400</span>
                        <button id="toggleLead3">‚úî</button> &emsp;&emsp;
                    </div>
                </div>

                <div id="segment">
                    Segment Marker
                    <button id="segmentStart" onclick="setSegmentStart()">Start</button>
                    <button id="segmentEnd" onclick="setSegmentEnd()">End</button>
                    <button id="segmentClear" onclick="clearSegment()">Clear</button></p>
                    <p>Modify ANN
                    <button id="segmentDelete" onclick="deleteSegmentMarkers()">Delete Segment Markers</button></p>
                    <p>Change Segment Markers
                    <select id="fromMarker">
                        <option value="N">N</option>
                        <option value="S">S</option>
                        <option value="Q">Q</option>
                        <option value="V">V</option>
                        <option value="B">B</option>
                    </select>
                    to
                    <select id="toMarker">
                        <option value="N">N</option>
                        <option value="S">S</option>
                        <option value="Q">Q</option>
                        <option value="V">V</option>
                        <option value="B">B</option>
                    </select>
                    <button id="changeMarkers" onclick="changeSegmentMarkers()">Change</button></p>
                </div>

                <!-- ANN Áµ±Ë®àÈ°ØÁ§∫ -->
                <div id="ann-statistics" style="background: white; padding: 20px; margin: 20px 0; border-radius: 10px; border: 2px solid #667eea; display: none;">
                    <h3 style="color: #667eea; margin-bottom: 15px;">üìä ANN Ê®ôË®òÁµ±Ë®à</h3>
                    <div id="ann-stats-content" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                    </div>
                </div>
            </div>

            <!-- FHIR Ë≥áË®äËº∏ÂÖ• -->
            <div style="background: #e3f2fd; padding: 15px; border-radius: 10px; margin-top: 20px;">
                <h3 style="margin-bottom: 10px;">FHIR Ë≥áÊ∫êË≥áË®ä</h3>
                <div class="form-row">
                    <div class="form-group">
                        <label for="ecg-datetime">ECG Ë®òÈåÑÊôÇÈñì *</label>
                        <input type="datetime-local" id="ecg-datetime">
                    </div>
                    <div class="form-group">
                        <label for="patient-id-for-ecg">ÁóÖÊÇ£ ID (ÈÅ∏Â°´)</label>
                        <input type="text" id="patient-id-for-ecg" placeholder="ÈóúËÅØÂà∞ÁâπÂÆöÁóÖÊÇ£">
                    </div>
                </div>
            </div>

            <div class="button-group" style="margin-top: 20px;">
                <button class="btn-primary" onclick="saveECGToFHIR()">üíæ ÂÑ≤Â≠ò ECG Âà∞ FHIR</button>
                <button class="btn-secondary" onclick="showInitial()">üè† ËøîÂõûÈ¶ñÈ†Å</button>
            </div>

            <div id="ecg-output" style="display:none; margin-top: 20px;">
                <h3>ÂÑ≤Â≠òÁµêÊûú</h3>
                <div id="ecg-result" class="info-box"></div>
            </div>
        </div>

        <!-- FHIR Server Ë®≠ÂÆö -->
        <div class="card">
            <h2>‚öôÔ∏è FHIR Server Ë®≠ÂÆö</h2>
            <div class="form-group">
                <label for="fhir-mode">‰ΩøÁî®Ê®°Âºè</label>
                <select id="fhir-mode" onchange="changeFHIRMode()" style="margin-bottom: 15px;">
                    <option value="local">Êú¨Âú∞ÈñãÁôºÊ®°ÂºèÔºàHTTPÔºâ</option>
                    <option value="github">GitHub Pages Ê®°ÂºèÔºàHTTPSÔºâ</option>
                </select>
            </div>
            <div class="form-group">
                <label for="baseUrl">Base URL</label>
                <input type="text" id="baseUrl" value="http://203.64.84.177:8080/fhir">
            </div>
            <p class="info" style="margin-top: 10px; color: #666; font-size: 0.9em;" id="fhir-mode-hint">
                üí° <strong>ÊèêÁ§∫:</strong> Êú¨Âú∞ÈñãÁôºÊ®°Âºè - ‰ΩøÁî® HTTP ‰º∫ÊúçÂô®
            </p>
        </div>
    </div>

    <script>
        // ========== ÂÖ®ÂüüËÆäÊï∏ ==========
        let ecgData = [[], [], []]; // ‰∏âÂ∞éÁ®ã ECG Êï∏Êìö
        let currentStartIndex = 0;
        let markers = [];
        let rr_data = []; // RR interval data
        let activeButton = -1;
        let segmentMode = null; // 'start' or 'end' for segment marker selection
        let canvas, ctx, zoomCanvas, zoomCtx;
        let progressBar, progressHandle;
        let leadOffsets = [100, 250, 400];
        let leadVisibility = [true, true, true];
        let segmentStartIndex = null;
        let segmentEndIndex = null;
        const samplingRate = 256;
        const visibleGrids = 10;
        
        // ‰∫ã‰ª∂ËôïÁêÜÂô®ÂºïÁî®ÔºàÁî®ÊñºÊ∏ÖÁêÜÔºâ
        let canvasClickHandler = null;
        let canvasContextMenuHandler = null;
        let canvasWheelHandler = null;
        let documentKeydownHandler = null;
        let progressMousemoveHandler = null;
        let progressMouseupHandler = null;

        // ========== Ê∏ÖÁ©∫ÊâÄÊúâ ECG Ë≥áÊñôÁöÑÂáΩÊï∏ ==========
        function clearAllECGData() {
            ecgData = [[], [], []];
            markers = [];
            rr_data = [];
            currentStartIndex = 0;
            activeButton = -1;
            segmentMode = null;
            segmentStartIndex = null;
            segmentEndIndex = null;
            zoomLevel = 1.0;
            zoomCenterIndex = 0;
            
            // Ê∏ÖÁ©∫Ê™îÊ°àËº∏ÂÖ•
            const ecgFileInput = document.getElementById('ecg-file');
            const annFileInput = document.getElementById('ann-file');
            if (ecgFileInput) ecgFileInput.value = '';
            if (annFileInput) annFileInput.value = '';
            
            // Èö±Ëóè Canvas ÂçÄÂüü
            const canvasArea = document.getElementById('ecg-canvas-area');
            if (canvasArea) canvasArea.style.display = 'none';
            
            // Èö±ËóèÁµ±Ë®àÂçÄÂüü
            const statsArea = document.getElementById('ann-statistics');
            if (statsArea) statsArea.style.display = 'none';
            
            // ÂèñÊ∂àÊâÄÊúâÊ®ôË®òÊåâÈàïÁöÑÊøÄÊ¥ªÁãÄÊÖã
            document.querySelectorAll('.marker-btn').forEach(btn => btn.classList.remove('active'));
            
            // Ê∏ÖÁ©∫ CanvasÔºàÂ¶ÇÊûúÂ∑≤ÂàùÂßãÂåñÔºâ
            if (canvas && ctx) {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'white';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
            if (zoomCanvas && zoomCtx) {
                zoomCtx.clearRect(0, 0, zoomCanvas.width, zoomCanvas.height);
                zoomCtx.fillStyle = '#f0f0f0';
                zoomCtx.fillRect(0, 0, zoomCanvas.width, zoomCanvas.height);
            }
            
            console.log('‚úÖ ÊâÄÊúâ ECG Ë≥áÊñôÂ∑≤Ê∏ÖÁ©∫');
        }

        // ========== È†ÅÈù¢ÂàáÊèõÂáΩÊï∏ ==========
        function hideAllSections() {
            // ÂàáÊèõÈ†ÅÈù¢ÊôÇÊ∏ÖÁêÜ‰∫ã‰ª∂Áõ£ËÅΩÂô®ÔºåÈò≤Ê≠¢Ë®òÊÜ∂È´îÊ¥©Êºè
            if (canvas) {
                cleanupCanvasEvents();
            }
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        }

        // ========== FHIR Ê®°ÂºèÂàáÊèõÂáΩÊï∏ ==========
        function changeFHIRMode() {
            const mode = document.getElementById('fhir-mode').value;
            const baseUrlInput = document.getElementById('baseUrl');
            const hint = document.getElementById('fhir-mode-hint');
            
            if (mode === 'local') {
                baseUrlInput.value = 'http://203.64.84.177:8080/fhir';
                hint.innerHTML = 'üí° <strong>ÊèêÁ§∫:</strong> Êú¨Âú∞ÈñãÁôºÊ®°Âºè - ‰ΩøÁî® HTTP ‰º∫ÊúçÂô®ÔºàÁõ¥Êé•ÈñãÂïü HTML ÊàñÊú¨Âú∞‰º∫ÊúçÂô®Ôºâ';
            } else if (mode === 'github') {
                baseUrlInput.value = 'https://server.fire.ly';
                hint.innerHTML = 'üí° <strong>ÊèêÁ§∫:</strong> GitHub Pages Ê®°Âºè - ‰ΩøÁî®ÊîØÊè¥ CORS ÁöÑ HTTPS Ê∏¨Ë©¶‰º∫ÊúçÂô®';
            }
        }

        // ========== È†ÅÈù¢ËºâÂÖ•ÊôÇËá™ÂãïÊ™¢Ê∏¨Ê®°Âºè ==========
        window.addEventListener('DOMContentLoaded', function() {
            // Â¶ÇÊûúÊòØ HTTPS ÂçîË≠∞ÔºåËá™ÂãïÂàáÊèõÂà∞ GitHub Ê®°Âºè
            if (window.location.protocol === 'https:') {
                document.getElementById('fhir-mode').value = 'github';
                changeFHIRMode();
            }
        });

        function showInitial() {
            hideAllSections();
            clearAllECGData(); // ËøîÂõûÈ¶ñÈ†ÅÊôÇÊ∏ÖÁ©∫ÊâÄÊúâË≥áÊñô
            document.getElementById('initial-section').classList.add('active');
            
            // ‰πüÊ∏ÖÁ©∫ Patient ID Ëº∏ÂÖ•
            document.getElementById('existing-patient-id').value = '';
            document.getElementById('patient-id-for-ecg').value = '';
            document.getElementById('patient-verification').style.display = 'none';
        }

        function showNewPatient() {
            hideAllSections();
            clearAllECGData(); // ÂàáÊèõÂà∞Âª∫Á´ãÁóÖÊÇ£È†ÅÈù¢ÊôÇÊ∏ÖÁ©∫Ë≥áÊñô
            document.getElementById('patient-section').classList.add('active');
        }

        function showQueryPatient() {
            hideAllSections();
            document.getElementById('query-section').classList.add('active');
        }

        function showQueryPage() {
            hideAllSections();
            clearAllECGData(); // ÂàáÊèõÂà∞Êü•Ë©¢È†ÅÈù¢ÊôÇÊ∏ÖÁ©∫Ë≥áÊñô
            document.getElementById('query-section').classList.add('active');
            document.getElementById('query-output').style.display = 'none';
            selectQueryType('patient');
        }

        function selectQueryType(type) {
            // Êõ¥Êñ∞ÊåâÈàïÁãÄÊÖã
            document.getElementById('query-type-patient').classList.toggle('active', type === 'patient');
            document.getElementById('query-type-observation').classList.toggle('active', type === 'observation');
            
            // ÂàáÊèõÈ°ØÁ§∫ÂçÄÂüü
            document.getElementById('query-patient-area').style.display = type === 'patient' ? 'block' : 'none';
            document.getElementById('query-observation-area').style.display = type === 'observation' ? 'block' : 'none';
            
            // Ê∏ÖÁ©∫Êü•Ë©¢ÁµêÊûú
            document.getElementById('query-output').style.display = 'none';
        }

        async function getObservation() {
            try {
                const baseUrl = document.getElementById('baseUrl').value.trim();
                const id = document.getElementById('queryObservationId').value.trim();

                if (!id) {
                    show('query-result', '‚ùå Ë´ãËº∏ÂÖ• Observation ID', 'error');
                    return;
                }

                show('query-result', 'Ê≠£Âú®Êü•Ë©¢ Observation...', 'info');

                const response = await fetch(`${baseUrl}/Observation/${id}`);
                
                let observationData;
                try {
                    observationData = await response.json();
                } catch (jsonError) {
                    console.error('JSON parsing error:', jsonError);
                    observationData = { error: 'Invalid JSON response' };
                }
                
                if (!response.ok) {
                    const resultDiv = document.getElementById('query-result');
                    
                    if (response.status === 404) {
                        resultDiv.innerHTML = `
                            <h3 style="color: #dc3545;">‚ùå Êü•Ë©¢Â§±Êïó</h3>
                            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 5px;">
                                <p style="margin: 0; color: #856404;"><strong>Observation ID "${id}" ‰∏çÂ≠òÂú®</strong></p>
                                <p style="margin: 5px 0 0 0; color: #856404; font-size: 0.9em;">Ë´ãÁ¢∫Ë™ç ID ÊòØÂê¶Ê≠£Á¢∫</p>
                            </div>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <h3 style="color: #dc3545;">‚ùå Êü•Ë©¢Â§±Êïó</h3>
                            <p><strong>ÁãÄÊÖãÁ¢ºÔºö</strong>${response.status}</p>
                            <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; overflow: auto;">${JSON.stringify(observationData, null, 2)}</pre>
                        `;
                    }
                    resultDiv.parentElement.style.display = 'block';
                    return;
                }
                
                const datetime = observationData.effectiveDateTime ? new Date(observationData.effectiveDateTime).toLocaleString('zh-TW') : 'N/A';
                const patientRef = observationData.subject && observationData.subject.reference ? observationData.subject.reference : 'N/A';
                const markerCount = observationData.note ? observationData.note.length : 0;
                const hasECGData = observationData.component && observationData.component.length >= 3;
                
                const resultDiv = document.getElementById('query-result');
                resultDiv.innerHTML = `
                    <h3 style="color: #28a745;">‚úÖ Êü•Ë©¢ÊàêÂäüÔºÅ</h3>
                    <table style="width: 100%; margin-top: 15px; border-collapse: collapse;">
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Observation ID:</strong></td>
                            <td style="padding: 8px; border-bottom: 1px solid #ddd; color: #667eea; font-weight: bold;">${id}</td></tr>
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Ë®òÈåÑÊôÇÈñì:</strong></td>
                            <td style="padding: 8px; border-bottom: 1px solid #ddd;">${datetime}</td></tr>
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>ÈóúËÅØÁóÖÊÇ£:</strong></td>
                            <td style="padding: 8px; border-bottom: 1px solid #ddd;">${patientRef}</td></tr>
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>ANN Ê®ôË®òÊï∏Èáè:</strong></td>
                            <td style="padding: 8px; border-bottom: 1px solid #ddd;">${markerCount} ÂÄã</td></tr>
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>ECG Êï∏Êìö:</strong></td>
                            <td style="padding: 8px; border-bottom: 1px solid #ddd;">${hasECGData ? '‚úÖ ÂåÖÂê´ 3 Â∞éÁ®ãÊï∏Êìö' : '‚ùå ÁÑ°Êï∏Êìö'}</td></tr>
                    </table>
                    <div style="margin-top: 15px;">
                        <button onclick="copyToClipboard('${id}')" style="width: auto; padding: 10px 20px; margin: 5px;">üìã Ë§áË£Ω ID</button>
                        ${hasECGData ? `<button onclick="loadObservationById('${id}')" style="width: auto; padding: 10px 20px; margin: 5px;">üëÅÔ∏è ËºâÂÖ•‰∏¶Êü•Áúã ECG</button>` : ''}
                    </div>
                `;
                resultDiv.parentElement.style.display = 'block';
                
            } catch (error) {
                show('query-result', `‚ùå ÈåØË™§: ${error.message}`, 'error');
            }
        }

        function showECGView() {
            hideAllSections();
            document.getElementById('ecg-section').classList.add('active');
        }

        function showExistingPatient() {
            hideAllSections();
            clearAllECGData(); // ÂàáÊèõÂà∞Â∑≤ÊúâÁóÖÊÇ£È†ÅÈù¢ÊôÇÊ∏ÖÁ©∫Ë≥áÊñô
            document.getElementById('existing-patient-section').classList.add('active');
            document.getElementById('patient-verification').style.display = 'none';
        }

        function showObservationList() {
            hideAllSections();
            document.getElementById('observation-list-section').classList.add('active');
            loadObservationsByPatient();
        }

        function showECGUpload() {
            hideAllSections();
            clearAllECGData(); // ÂàáÊèõÂà∞ ECG ‰∏äÂÇ≥È†ÅÈù¢ÊôÇÊ∏ÖÁ©∫‰πãÂâçÁöÑË≥áÊñô
            document.getElementById('ecg-section').classList.add('active');
            
            // Ëá™ÂãïÂ°´ÂÖ•Â∑≤È©óË≠âÁöÑ Patient IDÔºàÂ¶ÇÊûúÊúâÔºâ
            const existingPatientId = document.getElementById('existing-patient-id').value.trim();
            if (existingPatientId) {
                document.getElementById('patient-id-for-ecg').value = existingPatientId;
            }
        }

        // Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úÖ Â∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞øÔºö' + text);
            }).catch(err => {
                alert('‚ùå Ë§áË£ΩÂ§±ÊïóÔºö' + err);
            });
        }

        // ‰ΩøÁî® Patient ID ÂâçÂæÄ‰∏äÂÇ≥ ECG
        function usePatientIdForECG(patientId) {
            document.getElementById('patient-id-for-ecg').value = patientId;
            showECGView();
            alert('‚úÖ Patient ID Â∑≤Ëá™ÂãïÂ°´ÂÖ•ÔºåË´ã‰∏äÂÇ≥ ECG Ê™îÊ°à');
        }

        // ÂæûÊü•Ë©¢ÁµêÊûúÁõ¥Êé•Êü•ÁúãÁóÖÊÇ£ÁöÑ ECG ÂàóË°®
        function viewPatientObservations(patientId) {
            document.getElementById('existing-patient-id').value = patientId;
            showObservationList();
        }

        // ========== È°ØÁ§∫Ë®äÊÅØ ==========
        function show(elementId, msg, type = 'info') {
            const outputDiv = document.getElementById(elementId);
            const timestamp = new Date().toLocaleString('zh-TW');
            const className = type === 'success' ? 'success' : type === 'error' ? 'error' : 'info';
            
            if (typeof msg === 'object') {
                outputDiv.innerHTML = `<span class="${className}">[${timestamp}]</span>\n${JSON.stringify(msg, null, 2)}`;
            } else {
                outputDiv.innerHTML = `<span class="${className}">[${timestamp}] ${msg}</span>`;
            }
            outputDiv.parentElement.style.display = 'block';
        }

        // ========== Patient Áõ∏ÈóúÂáΩÊï∏ ==========
        function buildPatient() {
            const family = document.getElementById('family').value.trim();
            const given = document.getElementById('given').value.trim();
            const gender = document.getElementById('gender').value;
            const birthDate = document.getElementById('birthDate').value;
            const phone = document.getElementById('phone').value.trim();

            // Á¨¶Âêà FHIR R4 Patient Ë≥áÊ∫êÊ†ºÂºè
            const patient = {
                resourceType: 'Patient',
                meta: {
                    versionId: '1',
                    lastUpdated: new Date().toISOString(),
                    profile: ['http://hl7.org/fhir/StructureDefinition/Patient']
                },
                text: {
                    status: 'generated',
                    div: `<div xmlns="http://www.w3.org/1999/xhtml"><div class="hapiHeaderText">${given} <b>${family}</b></div><table class="hapiPropertyTable"><tbody><tr><td>Gender</td><td>${gender}</td></tr>${birthDate ? `<tr><td>Birth Date</td><td>${birthDate}</td></tr>` : ''}</tbody></table></div>`
                },
                identifier: [{
                    use: 'official',
                    system: 'http://hospital.example.org/patients',  // Âª∫Ë≠∞ÔºöÊîπÁÇ∫ÂØ¶ÈöõÁöÑÈÜ´Èô¢Ë≠òÂà•Á≥ªÁµ± URI
                    value: `PAT-${Date.now()}`
                }],
                active: true,
                name: [{
                    use: 'official',
                    family: family,
                    given: [given],
                    text: `${given} ${family}`
                }],
                gender: gender
            };

            if (birthDate) {
                // Á¢∫‰øùÊ†ºÂºèÁÇ∫YYYY-MM-DD
                patient.birthDate = birthDate;
            }

            if (phone) {
                patient.telecom = [{
                    system: 'phone',
                    value: phone,
                    use: 'mobile',
                    rank: 1
                }];
            }

            return patient;
        }

        async function createPatient() {
            try {
                const baseUrl = document.getElementById('baseUrl').value.trim();
                const patient = buildPatient();

                show('output', 'Ê≠£Âú®Âª∫Á´ã Patient Ë≥áÊñô...\n' + JSON.stringify(patient, null, 2), 'info');

                const response = await fetch(`${baseUrl}/Patient`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/fhir+json',
                        'Accept': 'application/fhir+json'
                    },
                    body: JSON.stringify(patient),
                    mode: 'cors',
                    credentials: 'omit'
                });

                const data = await response.json();

                if (response.ok) {
                    const location = response.headers.get('Location');
                    const id = data.id || (location ? location.split('/').pop() : 'unknown');
                    
                    // Âè™È°ØÁ§∫IDÔºå‰∏çÈ°ØÁ§∫ÂÆåÊï¥JSON
                    const outputDiv = document.getElementById('output');
                    outputDiv.innerHTML = `
                        <h3 style="color: #28a745;">‚úÖ Patient Âª∫Á´ãÊàêÂäüÔºÅ</h3>
                        <p style="font-size: 1.2em; margin: 15px 0;">
                            <strong>Patient ID:</strong> 
                            <span style="color: #667eea; font-size: 1.3em; font-weight: bold;">${id}</span>
                        </p>
                        <button onclick="copyToClipboard('${id}')" style="width: auto; padding: 10px 20px; margin: 5px;">üìã Ë§áË£Ω ID</button>
                        <button onclick="usePatientIdForECG('${id}')" style="width: auto; padding: 10px 20px; margin: 5px;">‚û°Ô∏è Á´ãÂç≥‰∏äÂÇ≥ ECG</button>
                    `;
                    outputDiv.parentElement.style.display = 'block';
                    return;
                } else {
                    show('output', {
                        message: '‚ùå Âª∫Á´ãÂ§±Êïó',
                        status: response.status,
                        error: data
                    }, 'error');
                }
            } catch (error) {
                console.error('createPatient Ë©≥Á¥∞ÈåØË™§:', error);
                
                const outputDiv = document.getElementById('output');
                if (!outputDiv) {
                    console.error('Êâæ‰∏çÂà∞ output ÂÖÉÁ¥†');
                    return;
                }
                
                const isNetworkError = error && (error.message === 'Load failed' || error.message === 'Failed to fetch' || error.name === 'TypeError');
                
                if (isNetworkError) {
                    const baseUrl = document.getElementById('baseUrl').value.trim();
                    outputDiv.innerHTML = `
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; border-radius: 8px;">
                            <h3 style="color: #856404; margin-top: 0;">‚ö†Ô∏è ÈÄ£Á∑öÂ§±Êïó</h3>
                            <p style="color: #856404; line-height: 1.8; margin: 15px 0;">
                                ÁÑ°Ê≥ïÈÄ£Êé•Âà∞ FHIR Server„ÄÇÂèØËÉΩÁöÑÂéüÂõ†Ôºö
                            </p>
                            
                            <ul style="color: #856404; line-height: 1.8;">
                                <li><strong>Á∂≤Ë∑ØÂïèÈ°åÔºö</strong>Ë´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö</li>
                                <li><strong>CORS ÈôêÂà∂Ôºö</strong>FHIR Server Êú™Ê≠£Á¢∫Ë®≠ÂÆö CORS headers</li>
                                <li><strong>‰º∫ÊúçÂô®ÂïèÈ°åÔºö</strong>FHIR Server ÂèØËÉΩÊö´ÊôÇÁÑ°Ê≥ï‰ΩøÁî®</li>
                            </ul>
                            
                            <h4 style="color: #856404; margin-top: 20px;">üí° Âª∫Ë≠∞Ôºö</h4>
                            <p style="color: #856404; margin: 10px 0;">
                                ‚úì Á¢∫Ë™ç Base URL ÊòØÂê¶Ê≠£Á¢∫<br>
                                ‚úì ÁõÆÂâç‰ΩøÁî®Ôºö<code style="background: white; padding: 3px 8px; border-radius: 4px;">${baseUrl}</code><br>
                                ‚úì Ë´ãÁ¢∫Ë™ç FHIR Server ÊòØÂê¶Ê≠£Â∏∏ÈÅã‰Ωú
                            </p>
                            
                            <div style="margin-top: 15px;">
                                <button onclick="testFHIRConnection()" style="
                                    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
                                    color: white;
                                    padding: 12px 24px;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
                                    width: 100%;
                                ">
                                    üîç Ê∏¨Ë©¶ FHIR Server ÈÄ£Á∑ö
                                </button>
                            </div>
                        </div>
                    `;
                } else {
                    outputDiv.innerHTML = `<p class="error">‚ùå ÈåØË™§: ${error.message}</p>`;
                }
                
                outputDiv.parentElement.style.display = 'block';
            }
        }

        async function getPatient() {
            try {
                const baseUrl = document.getElementById('baseUrl').value.trim();
                const id = document.getElementById('queryPatientId').value.trim();

                if (!id) {
                    show('query-result', '‚ùå Ë´ãËº∏ÂÖ• Patient ID', 'error');
                    return;
                }

                show('query-result', `Ê≠£Âú®Êü•Ë©¢ Patient ID: ${id}...`, 'info');

                const response = await fetch(`${baseUrl}/Patient/${id}`);
                
                let patientData;
                try {
                    patientData = await response.json();
                } catch (jsonError) {
                    console.error('JSON parsing error:', jsonError);
                    patientData = { error: 'Invalid JSON response' };
                }
                
                if (!response.ok) {
                    const resultDiv = document.getElementById('query-result');
                    
                    if (response.status === 404) {
                        resultDiv.innerHTML = `
                            <h3 style="color: #dc3545;">‚ùå Êü•Ë©¢Â§±Êïó</h3>
                            <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 15px; margin: 15px 0; border-radius: 5px;">
                                <p style="margin: 0; color: #856404;"><strong>Patient ID "${id}" ‰∏çÂ≠òÂú®</strong></p>
                                <p style="margin: 5px 0 0 0; color: #856404; font-size: 0.9em;">Ë´ãÁ¢∫Ë™ç ID ÊòØÂê¶Ê≠£Á¢∫ÔºåÊàñÂª∫Á´ãÊñ∞ÁöÑ Patient</p>
                            </div>
                            <button onclick="showNewPatient()" style="width: auto; padding: 10px 20px; margin: 5px;">‚ûï Âª∫Á´ãÊñ∞ÁóÖÊÇ£</button>
                        `;
                    } else {
                        resultDiv.innerHTML = `
                            <h3 style="color: #dc3545;">‚ùå Êü•Ë©¢Â§±Êïó</h3>
                            <p><strong>ÁãÄÊÖãÁ¢ºÔºö</strong>${response.status}</p>
                            <pre style="background: #f8f9fa; padding: 10px; border-radius: 5px; overflow: auto;">${JSON.stringify(patientData, null, 2)}</pre>
                        `;
                    }
                    resultDiv.parentElement.style.display = 'block';
                    return;
                }
                
                // Âè™È°ØÁ§∫ÈóúÈçµË≥áË®äÔºå‰∏çÈ°ØÁ§∫ÂÆåÊï¥JSON
                const name = patientData.name && patientData.name[0] ? `${patientData.name[0].given ? patientData.name[0].given.join(' ') : ''} ${patientData.name[0].family || ''}` : 'N/A';
                const gender = patientData.gender || 'N/A';
                const birthDate = patientData.birthDate || 'N/A';
                const phone = patientData.telecom && patientData.telecom[0] ? patientData.telecom[0].value : 'N/A';
                
                const resultDiv = document.getElementById('query-result');
                resultDiv.innerHTML = `
                    <h3 style="color: #28a745;">‚úÖ Êü•Ë©¢ÊàêÂäüÔºÅ</h3>
                    <table style="width: 100%; margin-top: 15px; border-collapse: collapse;">
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>Patient ID:</strong></td>
                            <td style="padding: 8px; border-bottom: 1px solid #ddd; color: #667eea; font-weight: bold;">${id}</td></tr>
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>ÂßìÂêç:</strong></td>
                            <td style="padding: 8px; border-bottom: 1px solid #ddd;">${name}</td></tr>
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>ÊÄßÂà•:</strong></td>
                            <td style="padding: 8px; border-bottom: 1px solid #ddd;">${gender}</td></tr>
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>ÁîüÊó•:</strong></td>
                            <td style="padding: 8px; border-bottom: 1px solid #ddd;">${birthDate}</td></tr>
                        <tr><td style="padding: 8px; border-bottom: 1px solid #ddd;"><strong>ÈõªË©±:</strong></td>
                            <td style="padding: 8px; border-bottom: 1px solid #ddd;">${phone}</td></tr>
                    </table>
                    <div style="margin-top: 15px;">
                        <button onclick="usePatientIdForECG('${id}')" style="width: auto; padding: 10px 20px;">‚û°Ô∏è ‰ΩøÁî®Ê≠§ ID ‰∏äÂÇ≥ ECG</button>
                        <button onclick="viewPatientObservations('${id}')" style="width: auto; padding: 10px 20px; margin-left: 5px;">üìã Êü•ÁúãÊ≠§ÁóÖÊÇ£ÁöÑ ECG ÂàóË°®</button>
                    </div>
                `;
                resultDiv.parentElement.style.display = 'block';
                return;
            } catch (error) {
                show('query-result', `‚ùå ÈåØË™§: ${error.message}`, 'error');
            }
        }

        // ========== FHIR Server ÈÄ£Á∑öÊ∏¨Ë©¶ÂáΩÊï∏ ==========
        async function testFHIRConnection() {
            const baseUrl = document.getElementById('baseUrl').value.trim();
            const resultDiv = document.getElementById('ecg-result') || document.getElementById('output');
            
            if (!resultDiv) {
                alert('Ê∏¨Ë©¶‰∏≠...');
                return;
            }
            
            resultDiv.innerHTML = '<p class="info">üîç Ê≠£Âú®Ê∏¨Ë©¶ FHIR Server ÈÄ£Á∑ö...</p>';
            resultDiv.parentElement.style.display = 'block';
            
            try {
                const response = await fetch(`${baseUrl}/metadata`, {
                    method: 'GET',
                    headers: {
                        'Accept': 'application/fhir+json'
                    },
                    mode: 'cors'
                });
                
                if (response.ok) {
                    const data = await response.json();
                    resultDiv.innerHTML = `
                        <div style="background: #d4edda; border-left: 4px solid #28a745; padding: 15px; border-radius: 8px;">
                            <h3 style="color: #155724; margin-top: 0;">‚úÖ ÈÄ£Á∑öÊàêÂäüÔºÅ</h3>
                            <p style="color: #155724; margin: 5px 0;"><strong>FHIR ÁâàÊú¨Ôºö</strong>${data.fhirVersion || 'Unknown'}</p>
                            <p style="color: #155724; margin: 5px 0;"><strong>‰º∫ÊúçÂô®Ôºö</strong>${data.software?.name || 'Unknown'} ${data.software?.version || ''}</p>
                            <p style="color: #155724; margin: 10px 0 0 0;">‚úì FHIR Server ÈÅã‰ΩúÊ≠£Â∏∏ÔºåÊÇ®ÂèØ‰ª•ÂòóË©¶ÈáçÊñ∞Âü∑Ë°åÊìç‰Ωú</p>
                        </div>
                    `;
                } else {
                    resultDiv.innerHTML = `
                        <div style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; border-radius: 8px;">
                            <h3 style="color: #721c24; margin-top: 0;">‚ùå ÈÄ£Á∑öÂ§±Êïó</h3>
                            <p style="color: #721c24;"><strong>ÁãÄÊÖãÁ¢ºÔºö</strong>${response.status}</p>
                            <p style="color: #721c24;">‰º∫ÊúçÂô®ÂõûÊáâÁï∞Â∏∏ÔºåË´ãÊ™¢Êü• Base URL ÊòØÂê¶Ê≠£Á¢∫</p>
                        </div>
                    `;
                }
            } catch (error) {
                resultDiv.innerHTML = `
                    <div style="background: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; border-radius: 8px;">
                        <h3 style="color: #721c24; margin-top: 0;">‚ùå ÁÑ°Ê≥ïÈÄ£Êé•</h3>
                        <p style="color: #721c24;"><strong>ÈåØË™§Ôºö</strong>${error.message}</p>
                        <p style="color: #721c24;">ÂèØËÉΩÂéüÂõ†Ôºö</p>
                        <ul style="color: #721c24; margin: 10px 0;">
                            <li>Base URL ÈåØË™§</li>
                            <li>FHIR Server Â∑≤ÈóúÈñâ</li>
                            <li>Á∂≤Ë∑ØÈÄ£Á∑öÂïèÈ°å</li>
                            <li>CORS Êú™Ê≠£Á¢∫Ë®≠ÂÆö</li>
                        </ul>
                    </div>
                `;
            }
        }

        // ========== ECG Ëß£ÊûêÂáΩÊï∏ ==========
        function parseECGText(text) {
            const lines = text.trim().split('\n');
            const lead1 = [], lead2 = [], lead3 = [];
            
            for (let line of lines) {
                const values = line.trim().split(/\s+/).map(v => parseFloat(v));
                if (values.length >= 3) {
                    lead1.push(values[0]);
                    lead2.push(values[1]);
                    lead3.push(values[2]);
                }
            }
            
            return [lead1, lead2, lead3];
        }

        // ========== Canvas Áπ™ÂúñÂáΩÊï∏ ==========
        function drawCanvas() {
            if (!canvas || ecgData[0].length === 0) return;
            
            const width = canvas.width;
            const height = canvas.height;
            
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, width, height);
            
            // Áπ™Ë£ΩÁ∂≤Ê†º (Ê®ôÊ∫ñÂøÉÈõªÂúñÊ†ºÂºè)
            const smallGrid = 5;  // Â∞èÊ†º 1mm
            const largeGrid = 25; // Â§ßÊ†º 5mm
            
            // Áπ™Ë£ΩÂ∞èÁ∂≤Ê†º
            ctx.strokeStyle = '#ffe0e0';
            ctx.lineWidth = 0.5;
            for (let x = 0; x < width; x += smallGrid) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            for (let y = 0; y < height; y += smallGrid) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Áπ™Ë£ΩÂ§ßÁ∂≤Ê†º
            ctx.strokeStyle = '#ffb0b0';
            ctx.lineWidth = 1;
            for (let x = 0; x < width; x += largeGrid) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
            }
            for (let y = 0; y < height; y += largeGrid) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.stroke();
            }
            
            // Áπ™Ë£Ω ECG Ê≥¢ÂΩ¢
            const visibleSamples = samplingRate * visibleGrids;
            const endIndex = Math.min(currentStartIndex + visibleSamples, ecgData[0].length);
            const xScale = width / visibleSamples;
            const yScale = 100;  // Y Ëª∏Á∏ÆÊîæÔºåËàáÂéüÂßãÊ®°Êùø‰∏ÄËá¥
            
            const colors = ['#ff0000', '#00ff00', '#0000ff'];
            const leadLabels = ['Lead I', 'Lead II', 'Lead III'];
            
            for (let lead = 0; lead < 3; lead++) {
                if (!leadVisibility[lead]) continue;
                
                // Áπ™Ë£ΩÂ∞éÁ®ãÊ®ôÁ±§
                ctx.fillStyle = colors[lead];
                ctx.font = 'bold 14px Arial';
                ctx.fillText(leadLabels[lead], 10, leadOffsets[lead] - 60);
                
                // Áπ™Ë£ΩÂü∫Á∑ö
                ctx.strokeStyle = colors[lead];
                ctx.lineWidth = 0.5;
                ctx.globalAlpha = 0.3;
                ctx.beginPath();
                ctx.moveTo(0, leadOffsets[lead]);
                ctx.lineTo(width, leadOffsets[lead]);
                ctx.stroke();
                ctx.globalAlpha = 1.0;
                
                // Áπ™Ë£ΩÊ≥¢ÂΩ¢
                ctx.strokeStyle = colors[lead];
                ctx.lineWidth = 1.5;
                ctx.beginPath();
                
                for (let i = currentStartIndex; i < endIndex; i++) {
                    const x = (i - currentStartIndex) * xScale;
                    const y = leadOffsets[lead] - ecgData[lead][i] * yScale;
                    
                    if (i === currentStartIndex) {
                        ctx.moveTo(x, y);
                    } else {
                        ctx.lineTo(x, y);
                    }
                }
                ctx.stroke();
            }
            
            // Áπ™Ë£Ω Segment Ê®ôË®ò
            if (segmentStartIndex !== null && segmentStartIndex >= currentStartIndex && segmentStartIndex < endIndex) {
                const x = (segmentStartIndex - currentStartIndex) * xScale;
                ctx.strokeStyle = '#00ff00';
                ctx.lineWidth = 3;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.fillStyle = '#00ff00';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('START', x + 5, 40);
            }
            
            if (segmentEndIndex !== null && segmentEndIndex >= currentStartIndex && segmentEndIndex < endIndex) {
                const x = (segmentEndIndex - currentStartIndex) * xScale;
                ctx.strokeStyle = '#ff0000';
                ctx.lineWidth = 3;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, height);
                ctx.stroke();
                ctx.setLineDash([]);
                
                ctx.fillStyle = '#ff0000';
                ctx.font = 'bold 16px Arial';
                ctx.fillText('END', x + 5, 40);
            }
            
            // Áπ™Ë£ΩÊ®ôË®òÔºàÂè™È°ØÁ§∫ÊñáÂ≠óÔºå‰∏çÈ°ØÁ§∫ÂúìÈªûÔºâ
            markers.forEach(marker => {
                if (marker.index >= currentStartIndex && marker.index < endIndex) {
                    const x = (marker.index - currentStartIndex) * xScale;
                    
                    // Ê†πÊìöÊ®ôË®òÈ°ûÂûãË®≠ÂÆöÈ°èËâ≤
                    let markerColor;
                    switch(marker.type) {
                        case 'N': markerColor = '#000000'; break; // ÈªëËâ≤
                        case 'S': markerColor = '#ff0000'; break; // Á¥ÖËâ≤
                        case 'Q': markerColor = '#00bfff'; break; // Ê∑∫ËóçËâ≤
                        case 'V': markerColor = '#9370db'; break; // Á¥´Ëâ≤
                        case 'B': markerColor = '#0000ff'; break; // ËóçËâ≤
                        default: markerColor = '#000000';
                    }
                    
                    // Âè™Âú®È†ÇÈÉ®Áπ™Ë£ΩÊ®ôË®òÈ°ûÂûãÊñáÂ≠óÔºå‰∏çÁπ™Ë£ΩÂúìÈªû
                    ctx.fillStyle = markerColor;
                    ctx.font = 'bold 14px Arial';
                    ctx.fillText(marker.type, x - 4, 20);
                }
            });
        }

        function calculateRRIntervals() {
            rr_data = []; // Clear existing RR data
            const sortedMarkers = [...markers].sort((a, b) => a.index - b.index);
            
            for (let i = 0; i < sortedMarkers.length - 1; i++) {
                const current = sortedMarkers[i];
                const next = sortedMarkers[i + 1];
                const rrInterval = next.index - current.index;
                rr_data.push({ 
                    start: current.index, 
                    end: next.index, 
                    interval: rrInterval 
                });
            }
            
            console.log('RR Intervals calculated:', rr_data.length);
            updateANNStatistics();
            drawZoomCanvas();
        }

        // ========== ANN Áµ±Ë®àÂäüËÉΩ ==========
        function updateANNStatistics() {
            const statsDiv = document.getElementById('ann-statistics');
            const contentDiv = document.getElementById('ann-stats-content');
            
            if (markers.length === 0) {
                statsDiv.style.display = 'none';
                return;
            }
            
            // Áµ±Ë®àÂêÑÈ°ûÂûãÊï∏Èáè
            const stats = {};
            markers.forEach(marker => {
                stats[marker.type] = (stats[marker.type] || 0) + 1;
            });
            
            const total = markers.length;
            const markerTypes = ['N', 'S', 'Q', 'V', 'B'];
            const markerNames = {
                'N': 'Normal (Ê≠£Â∏∏)',
                'S': 'Supraventricular (ÂÆ§‰∏äÊÄß)',
                'Q': 'Unclassified (Êú™ÂàÜÈ°û)',
                'V': 'Ventricular (ÂøÉÂÆ§)',
                'B': 'Bundle branch block (ÊùüÊîØÂÇ≥Â∞éÈòªÊªØ)'
            };
            const markerColors = {
                'N': '#000000',
                'S': '#ff0000',
                'Q': '#00bfff',
                'V': '#9370db',
                'B': '#0000ff'
            };
            
            // ÁîüÊàêÁµ±Ë®àÂç°Áâá
            let html = '';
            markerTypes.forEach(type => {
                const count = stats[type] || 0;
                const percentage = total > 0 ? (count / total * 100).toFixed(1) : 0;
                const color = markerColors[type];
                
                // ÊâæÂà∞Ë©≤È°ûÂûãÁöÑÁ¨¨‰∏ÄÂÄãÊ®ôË®ò
                const firstMarker = markers.find(m => m.type === type);
                const jumpButton = firstMarker ? 
                    `<button onclick="jumpToMarker(${firstMarker.index})" 
                            style="margin-top: 8px; padding: 6px 12px; background: ${color}; color: white; 
                                   border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;
                                   transition: all 0.3s ease; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"
                            onmouseover="this.style.transform='scale(1.05)'; this.style.boxShadow='0 4px 8px rgba(0,0,0,0.3)';"
                            onmouseout="this.style.transform='scale(1)'; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.2)';">
                        üéØ Ë∑≥ËΩâÂà∞Á¨¨‰∏ÄÂÄã
                    </button>` : '';
                
                html += `
                    <div style="background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); 
                                padding: 15px; border-radius: 8px; border-left: 4px solid ${color};
                                box-shadow: 0 2px 5px rgba(0,0,0,0.1);">
                        <div style="font-size: 1.5em; font-weight: bold; color: ${color}; margin-bottom: 5px;">${type}</div>
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 8px;">${markerNames[type]}</div>
                        <div style="font-size: 1.8em; font-weight: bold; color: #333;">${count}</div>
                        <div style="font-size: 0.85em; color: #888;">${percentage}%</div>
                        ${jumpButton}
                    </div>
                `;
            });
            
            // Ê∑ªÂä†Á∏ΩË®à
            html += `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                            padding: 15px; border-radius: 8px; color: white;
                            box-shadow: 0 2px 5px rgba(0,0,0,0.2);">
                    <div style="font-size: 1.5em; font-weight: bold; margin-bottom: 5px;">Á∏ΩË®à</div>
                    <div style="font-size: 0.9em; margin-bottom: 8px;">Total Markers</div>
                    <div style="font-size: 1.8em; font-weight: bold;">${total}</div>
                    <div style="font-size: 0.85em; opacity: 0.9;">100%</div>
                </div>
            `;
            
            contentDiv.innerHTML = html;
            statsDiv.style.display = 'block';
            
            // Ê∑ªÂä†È°çÂ§ñÁöÑË®∫Êñ∑Ë≥áË®äÔºàQ‰πüÁÆóÁï∞Â∏∏Ôºâ
            const abnormalCount = (stats['S'] || 0) + (stats['Q'] || 0) + (stats['V'] || 0) + (stats['B'] || 0);
            const abnormalPercentage = total > 0 ? (abnormalCount / total * 100).toFixed(1) : 0;
            
            let diagnosisHtml = '<div style="margin-top: 15px; padding: 15px; background: #fff3cd; border-radius: 8px; border-left: 4px solid #ffc107;">';
            diagnosisHtml += '<h4 style="margin: 0 0 10px 0; color: #856404;">üìã Ë®∫Êñ∑ÂèÉËÄÉ</h4>';
            
            if (abnormalCount === 0) {
                diagnosisHtml += '<p style="margin: 0; color: #155724; font-weight: bold;">‚úì Êú™Ê™¢Ê∏¨Âà∞Áï∞Â∏∏ÂøÉË∑≥</p>';
            } else {
                diagnosisHtml += `<p style="margin: 5px 0; color: #856404;"><strong>Áï∞Â∏∏ÂøÉË∑≥Êï∏ÈáèÔºö</strong>${abnormalCount} (${abnormalPercentage}%)</p>`;
                
                if (stats['V'] && stats['V'] > 0) {
                    const firstV = markers.find(m => m.type === 'V');
                    diagnosisHtml += `<p style="margin: 5px 0; color: #721c24;">
                        ‚ö†Ô∏è <strong>ÂøÉÂÆ§ÊÄßÁï∞Â∏∏ (V)Ôºö</strong>${stats['V']} Ê¨° - Âª∫Ë≠∞ÈÄ≤‰∏ÄÊ≠•Ê™¢Êü•
                        ${firstV ? `<button onclick="jumpToMarker(${firstV.index})" style="margin-left: 10px; padding: 4px 10px; background: #9370db; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">üéØ Êü•Áúã</button>` : ''}
                    </p>`;
                }
                if (stats['S'] && stats['S'] > 0) {
                    const firstS = markers.find(m => m.type === 'S');
                    diagnosisHtml += `<p style="margin: 5px 0; color: #856404;">
                        ‚ö†Ô∏è <strong>ÂÆ§‰∏äÊÄßÁï∞Â∏∏ (S)Ôºö</strong>${stats['S']} Ê¨°
                        ${firstS ? `<button onclick="jumpToMarker(${firstS.index})" style="margin-left: 10px; padding: 4px 10px; background: #ff0000; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">üéØ Êü•Áúã</button>` : ''}
                    </p>`;
                }
                if (stats['Q'] && stats['Q'] > 0) {
                    const firstQ = markers.find(m => m.type === 'Q');
                    diagnosisHtml += `<p style="margin: 5px 0; color: #856404;">
                        ‚ö†Ô∏è <strong>Êú™ÂàÜÈ°ûÁï∞Â∏∏ (Q)Ôºö</strong>${stats['Q']} Ê¨° - ÈúÄ‰∫∫Â∑•Âà§ËÆÄ
                        ${firstQ ? `<button onclick="jumpToMarker(${firstQ.index})" style="margin-left: 10px; padding: 4px 10px; background: #00bfff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">üéØ Êü•Áúã</button>` : ''}
                    </p>`;
                }
                if (stats['B'] && stats['B'] > 0) {
                    const firstB = markers.find(m => m.type === 'B');
                    diagnosisHtml += `<p style="margin: 5px 0; color: #856404;">
                        ‚ö†Ô∏è <strong>ÊùüÊîØÂÇ≥Â∞éÈòªÊªØ (B)Ôºö</strong>${stats['B']} Ê¨°
                        ${firstB ? `<button onclick="jumpToMarker(${firstB.index})" style="margin-left: 10px; padding: 4px 10px; background: #0000ff; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.85em;">üéØ Êü•Áúã</button>` : ''}
                    </p>`;
                }
            }
            
            diagnosisHtml += '</div>';
            contentDiv.innerHTML += diagnosisHtml;
        }

        // ÂÖ®Âüü RR È°ØÁ§∫ËÆäÊï∏
        let zoomLevel = 1.0; // 1.0 = ÂÖ®ÈÉ®È°ØÁ§∫
        let zoomCenterIndex = 0; // ÊîæÂ§ß‰∏≠ÂøÉÈªû

        function drawZoomCanvas() {
            if (!zoomCanvas) return;
            
            const width = zoomCanvas.width;
            const height = zoomCanvas.height;
            
            zoomCtx.fillStyle = '#f0f0f0';
            zoomCtx.fillRect(0, 0, width, height);
            
            if (rr_data.length === 0) return;
            
            // Ê†πÊìöÊîæÂ§ßÁ¥öÂà•Ê±∫ÂÆöÈ°ØÁ§∫ÁØÑÂúç
            let displayRR;
            if (zoomLevel === 1.0) {
                // È°ØÁ§∫ÂÖ®ÈÉ® RR intervals
                displayRR = rr_data;
            } else {
                // ÊîæÂ§ßÊ®°ÂºèÔºöÈ°ØÁ§∫‰ª• zoomCenterIndex ÁÇ∫‰∏≠ÂøÉÁöÑÁØÑÂúç
                const totalSamples = ecgData[0].length;
                const zoomedSamples = totalSamples / zoomLevel;
                const startIdx = Math.max(0, zoomCenterIndex - zoomedSamples / 2);
                const endIdx = Math.min(totalSamples, zoomCenterIndex + zoomedSamples / 2);
                
                displayRR = rr_data.filter(rr => 
                    rr.start >= startIdx && rr.start < endIdx
                );
            }
            
            if (displayRR.length === 0) return;
            
            // Ë®àÁÆó RR interval ÁØÑÂúç
            const rrValues = displayRR.map(d => d.interval);
            const maxRR = Math.max(...rrValues);
            const minRR = Math.min(...rrValues);
            const rangeRR = maxRR - minRR || 1;
            
            // YËª∏Á∏ÆÊîæÔºöÁΩÆ‰∏≠È°ØÁ§∫
            const verticalPadding = 20;
            const availableHeight = height - 2 * verticalPadding;
            const midY = height / 2;
            
            // XËª∏Á∏ÆÊîæÔºöÊ†πÊìöÈ°ØÁ§∫ÁöÑÁØÑÂúç
            let scaleX, offsetX;
            if (zoomLevel === 1.0) {
                // ÂÖ®ÈÉ®È°ØÁ§∫Ôºö‰ΩøÁî®ÊâÄÊúâ ECG Êï∏ÊìöÁöÑÁØÑÂúç
                const totalSamples = ecgData[0].length;
                scaleX = width / totalSamples;
                offsetX = 0;
            } else {
                // ÊîæÂ§ßÈ°ØÁ§∫
                const totalSamples = ecgData[0].length;
                const zoomedSamples = totalSamples / zoomLevel;
                const startIdx = Math.max(0, zoomCenterIndex - zoomedSamples / 2);
                scaleX = width / zoomedSamples;
                offsetX = startIdx;
            }
            
            // Áπ™Ë£Ω RR interval ÊäòÁ∑öÂúñ
            zoomCtx.strokeStyle = '#667eea';
            zoomCtx.lineWidth = 2;
            zoomCtx.beginPath();
            
            let isFirstPoint = true;
            for (let i = 0; i < displayRR.length; i++) {
                const x = (displayRR[i].start - offsetX) * scaleX;
                const normalizedY = (displayRR[i].interval - minRR) / rangeRR;
                const y = midY - (normalizedY - 0.5) * availableHeight;
                
                if (isFirstPoint) {
                    zoomCtx.moveTo(x, y);
                    isFirstPoint = false;
                } else {
                    zoomCtx.lineTo(x, y);
                }
            }
            zoomCtx.stroke();
            
            // È°ØÁ§∫ÊîæÂ§ßÁ¥öÂà•Ë≥áË®ä
            if (zoomLevel > 1.0) {
                const totalSamples = ecgData[0].length;
                const currentSamples = totalSamples / zoomLevel;
                const currentDuration = currentSamples / samplingRate; // Áï∂ÂâçÈ°ØÁ§∫ÁöÑÁßíÊï∏
                
                zoomCtx.fillStyle = '#667eea';
                zoomCtx.font = 'bold 14px Arial';
                
                if (currentDuration >= 60) {
                    zoomCtx.fillText(`È°ØÁ§∫ÁØÑÂúç: ${Math.round(currentDuration / 60)} ÂàÜÈêò`, 10, 20);
                } else {
                    zoomCtx.fillText(`È°ØÁ§∫ÁØÑÂúç: ${Math.round(currentDuration)} Áßí`, 10, 20);
                }
            } else {
                const totalDuration = ecgData[0].length / samplingRate;
                zoomCtx.fillStyle = '#666';
                zoomCtx.font = '12px Arial';
                
                if (totalDuration >= 60) {
                    zoomCtx.fillText(`RR Intervals (ÂÖ®ÈÉ®È°ØÁ§∫: ${Math.round(totalDuration / 60)} ÂàÜÈêò)`, 10, 20);
                } else {
                    zoomCtx.fillText(`RR Intervals (ÂÖ®ÈÉ®È°ØÁ§∫: ${Math.round(totalDuration)} Áßí)`, 10, 20);
                }
            }
            
            // È°ØÁ§∫ RR Áµ±Ë®àË≥áË®ä
            zoomCtx.fillStyle = '#666';
            zoomCtx.font = '11px Arial';
            zoomCtx.fillText(`Max: ${maxRR.toFixed(0)} | Min: ${minRR.toFixed(0)} | Avg: ${(rrValues.reduce((a,b)=>a+b,0)/rrValues.length).toFixed(0)}`, 10, height - 10);
        }

        function updateProgressBar() {
            if (!progressHandle || ecgData[0].length === 0) return;
            
            const totalSamples = ecgData[0].length;
            const position = (currentStartIndex / totalSamples) * 100;
            progressHandle.style.left = position + '%';
        }

        // ========== ECG Ê™îÊ°à‰∏äÂÇ≥ËôïÁêÜ ==========
        document.getElementById('ecg-file')?.addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                ecgData = parseECGText(event.target.result);
                currentStartIndex = 0;
                markers = [];
                segmentStartIndex = null;
                segmentEndIndex = null;
                
                // ÂàùÂßãÂåñ Canvas
                canvas = document.getElementById('dataCanvas');
                ctx = canvas.getContext('2d');
                zoomCanvas = document.getElementById('zoomCanvas');
                zoomCtx = zoomCanvas.getContext('2d');
                progressBar = document.getElementById('progress-bar');
                progressHandle = document.getElementById('progress-handle');
                
                document.getElementById('ecg-canvas-area').style.display = 'block';
                
                drawCanvas();
                drawZoomCanvas();
                updateProgressBar();
                setupCanvasEvents();
                
                console.log(`ECG Ê™îÊ°àËºâÂÖ•ÊàêÂäüÔºÅÂÖ±Êúâ ${ecgData[0].length} ÂÄãÊ®£Êú¨Èªû`);
            };
            reader.readAsText(file);
        });

        // ========== Ê∏ÖÁêÜ Canvas ‰∫ã‰ª∂ ==========
        function cleanupCanvasEvents() {
            if (canvas && canvasClickHandler) {
                canvas.removeEventListener('click', canvasClickHandler);
            }
            if (canvas && canvasContextMenuHandler) {
                canvas.removeEventListener('contextmenu', canvasContextMenuHandler);
            }
            if (canvas && canvasWheelHandler) {
                canvas.removeEventListener('wheel', canvasWheelHandler);
            }
            if (documentKeydownHandler) {
                document.removeEventListener('keydown', documentKeydownHandler);
            }
            if (progressMousemoveHandler) {
                document.removeEventListener('mousemove', progressMousemoveHandler);
            }
            if (progressMouseupHandler) {
                document.removeEventListener('mouseup', progressMouseupHandler);
            }
        }

        // ========== Canvas ‰∫ã‰ª∂Ë®≠ÂÆö ==========
        function setupCanvasEvents() {
            // ÂÖàÊ∏ÖÁêÜËàäÁöÑ‰∫ã‰ª∂Áõ£ËÅΩÂô®
            cleanupCanvasEvents();
            // Ê®ôË®òÊåâÈàï - ‰ΩøÁî®ÊåâÈàï ID ‰æÜË®≠ÂÆö
            document.getElementById('btn1').onclick = function() {
                document.querySelectorAll('.marker-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                activeButton = 1;
            };
            document.getElementById('btn2').onclick = function() {
                document.querySelectorAll('.marker-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                activeButton = 2;
            };
            document.getElementById('btn3').onclick = function() {
                document.querySelectorAll('.marker-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                activeButton = 3;
            };
            document.getElementById('btn4').onclick = function() {
                document.querySelectorAll('.marker-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                activeButton = 4;
            };
            document.getElementById('btn5').onclick = function() {
                document.querySelectorAll('.marker-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                activeButton = 5;
            };
            document.getElementById('btnDelete').onclick = function() {
                document.querySelectorAll('.marker-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                activeButton = 6;
            };
            
            // Canvas ÈªûÊìäÊ∑ªÂä†Ê®ôË®ò
            canvasClickHandler = function(e) {
                const rect = canvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                // Ë®àÁÆó Canvas ÂÖßÈÉ®ÂùêÊ®ôÔºàËÄÉÊÖÆÈ°ØÁ§∫Á∏ÆÊîæÔºâ
                const scaleX = canvas.width / rect.width;
                const canvasX = clickX * scaleX;
                const visibleSamples = samplingRate * visibleGrids;
                const clickIndex = currentStartIndex + Math.round((canvasX / canvas.width) * visibleSamples);
                
                // ËôïÁêÜ Segment Marker Ë®≠ÂÆö
                if (segmentMode === 'start') {
                    segmentStartIndex = clickIndex;
                    segmentMode = null;
                    alert(`‚úì Segment Start Ë®≠ÂÆöÂú®Ê®£Êú¨ ${clickIndex}`);
                    drawCanvas();
                    return;
                } else if (segmentMode === 'end') {
                    segmentEndIndex = clickIndex;
                    segmentMode = null;
                    alert(`‚úì Segment End Ë®≠ÂÆöÂú®Ê®£Êú¨ ${clickIndex}`);
                    drawCanvas();
                    return;
                }
                
                // ËôïÁêÜÊ®ôË®òÊ∑ªÂä†/Âà™Èô§/‰øÆÊîπÔºàÊô∫ËÉΩÊ®°ÂºèÔºâ
                if (activeButton === -1) return;
                
                if (activeButton === 6) { // Delete ÊåâÈàïÔºöÂè™Âà™Èô§
                    markers = markers.filter(m => Math.abs(m.index - clickIndex) > 5);
                } else {
                    // Êô∫ËÉΩÊ®ôË®òÈÇèËºØ
                    const markerTypes = ['N', 'S', 'Q', 'V', 'B'];
                    const newMarkerType = markerTypes[activeButton - 1];
                    
                    // Â∞ãÊâæÈªûÊìä‰ΩçÁΩÆÈôÑËøëÁöÑÁèæÊúâÊ®ôË®òÔºàÂÆπÂ∑ÆÁØÑÂúçÔºö5ÂÄãÊ®£Êú¨ÈªûÔºâ
                    const existingMarkerIndex = markers.findIndex(m => Math.abs(m.index - clickIndex) <= 5);
                    
                    if (existingMarkerIndex !== -1) {
                        // ÊâæÂà∞ÁèæÊúâÊ®ôË®ò
                        const existingMarker = markers[existingMarkerIndex];
                        
                        if (existingMarker.type === newMarkerType) {
                            // Áõ∏ÂêåÈ°ûÂûãÔºöÂà™Èô§
                            markers.splice(existingMarkerIndex, 1);
                        } else {
                            // ‰∏çÂêåÈ°ûÂûãÔºöÊõ¥ÊîπÁÇ∫Êñ∞È°ûÂûã
                            markers[existingMarkerIndex].type = newMarkerType;
                        }
                    } else {
                        // Ê≤íÊúâÁèæÊúâÊ®ôË®òÔºöÊñ∞Â¢û
                        markers.push({
                            index: clickIndex,
                            type: newMarkerType
                        });
                    }
                }
                
                calculateRRIntervals(); // ÈáçÊñ∞Ë®àÁÆó RR intervalsÔºàÊúÉËá™ÂãïÊõ¥Êñ∞Áµ±Ë®àÔºâ
                drawCanvas();
            };
            canvas.addEventListener('click', canvasClickHandler);
            
            // ÈÄ≤Â∫¶Ê¢ùÊãñÂãï
            let isDragging = false;
            progressHandle.onmousedown = () => isDragging = true;
            
            progressMouseupHandler = () => isDragging = false;
            document.addEventListener('mouseup', progressMouseupHandler);
            
            progressMousemoveHandler = function(e) {
                if (!isDragging) return;
                
                const rect = progressBar.getBoundingClientRect();
                let x = e.clientX - rect.left;
                x = Math.max(0, Math.min(x, rect.width));
                
                const percentage = x / rect.width;
                const totalSamples = ecgData[0].length;
                currentStartIndex = Math.floor(percentage * totalSamples);
                currentStartIndex = Math.max(0, Math.min(currentStartIndex, totalSamples - samplingRate * visibleGrids));
                
                drawCanvas();
                syncRRWithECG(); // RR Ë∑üÈö® ECG
                updateProgressBar();
            };
            document.addEventListener('mousemove', progressMousemoveHandler);
            
            // Lead ‰ΩçÁΩÆË™øÊï¥
            for (let i = 1; i <= 3; i++) {
                const slider = document.getElementById(`lead${i}-offset`);
                const valueSpan = document.getElementById(`lead${i}-offset-value`);
                const toggleBtn = document.getElementById(`toggleLead${i}`);
                
                slider.oninput = function() {
                    leadOffsets[i-1] = parseInt(this.value);
                    valueSpan.textContent = this.value;
                    drawCanvas();
                };
                
                toggleBtn.onclick = function() {
                    leadVisibility[i-1] = !leadVisibility[i-1];
                    this.classList.toggle('inactive');
                    drawCanvas();
                };
            }
            
            // ÈçµÁõ§Â∑¶Âè≥ÊñπÂêëÈçµÊéßÂà∂
            documentKeydownHandler = function(e) {
                if (ecgData[0].length === 0) return;
                
                const totalSamples = ecgData[0].length;
                const visibleSamples = samplingRate * visibleGrids;
                const step = Math.floor(visibleSamples * 0.1); // ÊØèÊ¨°ÁßªÂãï 10% ÁöÑÂèØË¶ãÁØÑÂúç
                
                if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    currentStartIndex = Math.max(0, currentStartIndex - step);
                    drawCanvas();
                    syncRRWithECG(); // RR Ë∑üÈö® ECG
                    updateProgressBar();
                } else if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    currentStartIndex = Math.min(totalSamples - visibleSamples, currentStartIndex + step);
                    drawCanvas();
                    syncRRWithECG(); // RR Ë∑üÈö® ECG
                    updateProgressBar();
                }
            };
            document.addEventListener('keydown', documentKeydownHandler);
            
            // ÊªëÈº†ÊªæËº™ÊéßÂà∂
            canvasWheelHandler = function(e) {
                e.preventDefault();
                if (ecgData[0].length === 0) return;
                
                const totalSamples = ecgData[0].length;
                const visibleSamples = samplingRate * visibleGrids;
                const step = Math.floor(visibleSamples * 0.05); // ÊØèÊ¨°ÊªæÂãïÁßªÂãï 5% ÁöÑÂèØË¶ãÁØÑÂúç
                
                if (e.deltaY < 0) {
                    // Âêë‰∏äÊªæÔºöÂêëÂâçÁßªÂãï
                    currentStartIndex = Math.max(0, currentStartIndex - step);
                } else {
                    // Âêë‰∏ãÊªæÔºöÂêëÂæåÁßªÂãï
                    currentStartIndex = Math.min(totalSamples - visibleSamples, currentStartIndex + step);
                }
                
                drawCanvas();
                syncRRWithECG(); // RR Ë∑üÈö® ECG
                updateProgressBar();
            };
            canvas.addEventListener('wheel', canvasWheelHandler);
            
            // RR interval canvas ÊªëÈº†Âè≥ÈçµÊîæÂ§ßÂäüËÉΩ
            zoomCanvas.addEventListener('contextmenu', function(e) {
                e.preventDefault();
                if (rr_data.length === 0) return;
                
                const rect = zoomCanvas.getBoundingClientRect();
                const clickX = e.clientX - rect.left;
                const scaleX = zoomCanvas.width / rect.width;
                const canvasX = clickX * scaleX;
                
                // Ë®àÁÆóÈªûÊìä‰ΩçÁΩÆÂ∞çÊáâÁöÑ sample index
                const totalSamples = ecgData[0].length;
                zoomCenterIndex = Math.floor((canvasX / zoomCanvas.width) * totalSamples);
                
                // ÊîæÂ§ßÈÅ∏È†ÖÔºöÂÖ®ÈÉ® ‚Üí 1ÂàÜÈêò ‚Üí 30Áßí ‚Üí 10Áßí ‚Üí ÂÖ®ÈÉ®
                const totalDuration = totalSamples / samplingRate; // Á∏ΩÁßíÊï∏
                const oneMinuteSamples = samplingRate * 60; // 1ÂàÜÈêòÁöÑÊ®£Êú¨Êï∏
                const thirtySecSamples = samplingRate * 30; // 30ÁßíÁöÑÊ®£Êú¨Êï∏
                const tenSecSamples = samplingRate * 10; // 10ÁßíÁöÑÊ®£Êú¨Êï∏
                
                if (zoomLevel === 1.0) {
                    // ÂæûÂÖ®ÈÉ®È°ØÁ§∫ ‚Üí 1ÂàÜÈêò
                    zoomLevel = totalSamples / oneMinuteSamples;
                } else {
                    const currentSamples = totalSamples / zoomLevel;
                    if (currentSamples > 45 * samplingRate) {
                        // Áï∂ÂâçÈ°ØÁ§∫ > 45Áßí ‚Üí ÂàáÊèõÂà∞ 30Áßí
                        zoomLevel = totalSamples / thirtySecSamples;
                    } else if (currentSamples > 20 * samplingRate) {
                        // Áï∂ÂâçÈ°ØÁ§∫ > 20Áßí ‚Üí ÂàáÊèõÂà∞ 10Áßí
                        zoomLevel = totalSamples / tenSecSamples;
                    } else {
                        // Âê¶ÂâáÈáçÁΩÆÁÇ∫ÂÖ®ÈÉ®È°ØÁ§∫
                        zoomLevel = 1.0;
                        zoomCenterIndex = 0;
                    }
                }
                
                // ÂêåÊ≠• ECG È°ØÁ§∫‰ΩçÁΩÆ
                syncECGWithRR();
                drawZoomCanvas();
            });
            
            // RR interval canvas ÈõôÊìäÈáçÁΩÆ
            zoomCanvas.addEventListener('dblclick', function(e) {
                e.preventDefault();
                zoomLevel = 1.0;
                zoomCenterIndex = 0;
                syncECGWithRR();
                drawZoomCanvas();
            });
            
            // RR interval canvas ÊãñÂãïÂäüËÉΩÔºàÊîæÂ§ßÊôÇÔºâ
            let isZoomDragging = false;
            let zoomDragStartX = 0;
            let zoomDragStartCenter = 0;
            
            zoomCanvas.addEventListener('mousedown', function(e) {
                if (zoomLevel > 1.0 && e.button === 0) { // Â∑¶Èçµ‰∏îËôïÊñºÊîæÂ§ßÁãÄÊÖã
                    isZoomDragging = true;
                    zoomDragStartX = e.clientX;
                    zoomDragStartCenter = zoomCenterIndex;
                    zoomCanvas.style.cursor = 'grabbing';
                }
            });
            
            document.addEventListener('mouseup', function() {
                if (isZoomDragging) {
                    isZoomDragging = false;
                    zoomCanvas.style.cursor = zoomLevel > 1.0 ? 'grab' : 'default';
                }
            });
            
            document.addEventListener('mousemove', function(e) {
                if (!isZoomDragging) return;
                
                const totalSamples = ecgData[0].length;
                const zoomedSamples = totalSamples / zoomLevel;
                const rect = zoomCanvas.getBoundingClientRect();
                const deltaX = e.clientX - zoomDragStartX;
                const deltaPercent = deltaX / rect.width;
                const deltaSamples = Math.floor(deltaPercent * zoomedSamples);
                
                // Êõ¥Êñ∞‰∏≠ÂøÉ‰ΩçÁΩÆÔºàÊ≥®ÊÑèÊãñÂãïÊñπÂêëÁõ∏ÂèçÔºâ
                zoomCenterIndex = zoomDragStartCenter - deltaSamples;
                
                // ÈôêÂà∂ÁØÑÂúç
                const halfZoomedSamples = zoomedSamples / 2;
                zoomCenterIndex = Math.max(halfZoomedSamples, Math.min(totalSamples - halfZoomedSamples, zoomCenterIndex));
                
                // ÂêåÊ≠• ECG È°ØÁ§∫‰ΩçÁΩÆ
                syncECGWithRR();
                drawZoomCanvas();
            });
            
            // RR interval canvas ÊªæËº™ÁßªÂãïÔºàÊîæÂ§ßÊôÇÔºâ
            zoomCanvas.addEventListener('wheel', function(e) {
                if (zoomLevel > 1.0) {
                    e.preventDefault();
                    
                    const totalSamples = ecgData[0].length;
                    const zoomedSamples = totalSamples / zoomLevel;
                    const step = Math.floor(zoomedSamples * 0.1); // ÊØèÊ¨°ÁßªÂãï 10%
                    
                    if (e.deltaY < 0) {
                        // ÂêëÂ∑¶ÁßªÂãï
                        zoomCenterIndex = Math.max(zoomedSamples / 2, zoomCenterIndex - step);
                    } else {
                        // ÂêëÂè≥ÁßªÂãï
                        zoomCenterIndex = Math.min(totalSamples - zoomedSamples / 2, zoomCenterIndex + step);
                    }
                    
                    // ÂêåÊ≠• ECG È°ØÁ§∫‰ΩçÁΩÆ
                    syncECGWithRR();
                    drawZoomCanvas();
                }
            });
            
            // Ë®≠ÂÆöÊ∏∏Ê®ôÊ®£Âºè
            zoomCanvas.addEventListener('mouseenter', function() {
                if (zoomLevel > 1.0) {
                    zoomCanvas.style.cursor = 'grab';
                } else {
                    zoomCanvas.style.cursor = 'default';
                }
            });
        }

        // ========== ECG Ëàá RR ÂêåÊ≠•ÂäüËÉΩ ==========
        function syncECGWithRR() {
            if (zoomLevel === 1.0 || !ecgData || ecgData[0].length === 0) {
                // ÂÖ®ÈÉ®È°ØÁ§∫ÊôÇ‰∏çÂêåÊ≠•Ôºå‰øùÊåÅ ECG Áç®Á´ãÊìç‰Ωú
                return;
            }
            
            // Ë®àÁÆó RR Áï∂ÂâçÈ°ØÁ§∫ÁöÑ‰∏≠ÂøÉ‰ΩçÁΩÆ
            // ËÆì ECG ÁöÑ‰∏≠ÂøÉÂ∞çÈΩä RR ÁöÑ‰∏≠ÂøÉ
            const visibleSamples = samplingRate * visibleGrids; // ECG ÂèØË¶ã 10 Áßí
            
            // Ë®≠ÂÆö ECG ÁöÑËµ∑Âßã‰ΩçÁΩÆÔºå‰ΩøÂÖ∂‰∏≠ÂøÉËàá RR ‰∏≠ÂøÉÂ∞çÈΩä
            currentStartIndex = Math.floor(zoomCenterIndex - visibleSamples / 2);
            
            // ÈôêÂà∂Âú®ÊúâÊïàÁØÑÂúçÂÖß
            const totalSamples = ecgData[0].length;
            currentStartIndex = Math.max(0, Math.min(currentStartIndex, totalSamples - visibleSamples));
            
            // Êõ¥Êñ∞ ECG È°ØÁ§∫
            drawCanvas();
            updateProgressBar();
        }

        // ========== RR Ë∑üÈö® ECG ÁßªÂãï ==========
        function syncRRWithECG() {
            if (!ecgData || ecgData[0].length === 0) {
                return;
            }
            
            // Ë®àÁÆó ECG Áï∂ÂâçÈ°ØÁ§∫ÁöÑ‰∏≠ÂøÉ‰ΩçÁΩÆ
            const visibleSamples = samplingRate * visibleGrids; // ECG ÂèØË¶ã 10 Áßí
            const ecgCenterIndex = currentStartIndex + visibleSamples / 2;
            
            // Êõ¥Êñ∞ RR ÁöÑ‰∏≠ÂøÉ‰ΩçÁΩÆÂà∞ ECG ‰∏≠ÂøÉ
            zoomCenterIndex = ecgCenterIndex;
            
            // Â¶ÇÊûú RR ÊúâÊîæÂ§ßÔºåÁ¢∫‰øù‰∏≠ÂøÉ‰ΩçÁΩÆÂú®ÊúâÊïàÁØÑÂúçÂÖß
            if (zoomLevel > 1.0) {
                const totalSamples = ecgData[0].length;
                const zoomedSamples = totalSamples / zoomLevel;
                const halfZoomedSamples = zoomedSamples / 2;
                zoomCenterIndex = Math.max(halfZoomedSamples, Math.min(totalSamples - halfZoomedSamples, zoomCenterIndex));
            }
            
            // Êõ¥Êñ∞ RR È°ØÁ§∫
            drawZoomCanvas();
        }

        // ========== Ë∑≥ËΩâÂà∞Ê®ôË®ò‰ΩçÁΩÆ ==========
        function jumpToMarker(markerIndex) {
            if (!ecgData || ecgData[0].length === 0) {
                alert('‚ùå Ë´ãÂÖàËºâÂÖ• ECG Êï∏Êìö');
                return;
            }
            
            // Â∞áË©≤Ê®ôË®ò‰ΩçÁΩÆË®≠ÁÇ∫ ECG È°ØÁ§∫ÁöÑ‰∏≠ÂøÉ
            const visibleSamples = samplingRate * visibleGrids; // 10ÁßíÂèØË¶ãÁØÑÂúç
            currentStartIndex = Math.floor(markerIndex - visibleSamples / 2);
            
            // ÈôêÂà∂Âú®ÊúâÊïàÁØÑÂúçÂÖß
            const totalSamples = ecgData[0].length;
            currentStartIndex = Math.max(0, Math.min(currentStartIndex, totalSamples - visibleSamples));
            
            // Â¶ÇÊûú RR ÊúâÊîæÂ§ßÔºåÂêåÊ≠• RR ‰∏≠ÂøÉ
            if (zoomLevel > 1.0) {
                zoomCenterIndex = markerIndex;
                drawZoomCanvas();
            }
            
            // Êõ¥Êñ∞È°ØÁ§∫
            drawCanvas();
            updateProgressBar();
            
            // Ê∑ªÂä†Ë¶ñË¶∫ÊèêÁ§∫
            const timeInSeconds = (markerIndex / samplingRate).toFixed(2);
            const marker = markers.find(m => m.index === markerIndex);
            const markerType = marker ? marker.type : 'Êú™Áü•';
            
            // ÊªæÂãïÂà∞ Canvas ÂçÄÂüü
            document.getElementById('dataCanvas').scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // È°ØÁ§∫ÊèêÁ§∫Ë®äÊÅØÔºà‰∏ç‰ΩøÁî® alertÔºåÊîπÁî®Êõ¥ÂèãÂñÑÁöÑÊñπÂºèÔºâ
            showJumpNotification(`Â∑≤Ë∑≥ËΩâÂà∞Ê®ôË®ò ${markerType} (‰ΩçÁΩÆ: ${markerIndex}, ÊôÇÈñì: ${timeInSeconds}s)`);
        }
        
        // È°ØÁ§∫Ë∑≥ËΩâÈÄöÁü•
        function showJumpNotification(message) {
            // ÁßªÈô§ËàäÁöÑÈÄöÁü•
            const oldNotification = document.getElementById('jump-notification');
            if (oldNotification) {
                oldNotification.remove();
            }
            
            // ÂâµÂª∫Êñ∞ÈÄöÁü•
            const notification = document.createElement('div');
            notification.id = 'jump-notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 10000;
                font-size: 14px;
                font-weight: bold;
                animation: slideInRight 0.3s ease, fadeOut 0.3s ease 2.7s;
            `;
            notification.innerHTML = `üéØ ${message}`;
            document.body.appendChild(notification);
            
            // 3ÁßíÂæåËá™ÂãïÁßªÈô§
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ========== Segment Marker ÂäüËÉΩ ==========
        function setSegmentStart() {
            segmentMode = 'start';
            activeButton = -1; // ÂèñÊ∂àÊ®ôË®òÊ®°Âºè
            alert('‚úì Ë´ãÂú® Canvas ‰∏äÈªûÊìäË®≠ÂÆö Segment Start ‰ΩçÁΩÆ');
        }

        function setSegmentEnd() {
            segmentMode = 'end';
            activeButton = -1; // ÂèñÊ∂àÊ®ôË®òÊ®°Âºè
            alert('‚úì Ë´ãÂú® Canvas ‰∏äÈªûÊìäË®≠ÂÆö Segment End ‰ΩçÁΩÆ');
        }

        function clearSegment() {
            segmentStartIndex = null;
            segmentEndIndex = null;
            alert('‚úì Segment Ê®ôË®òÂ∑≤Ê∏ÖÈô§');
            drawCanvas();
        }

        function deleteSegmentMarkers() {
            if (segmentStartIndex === null || segmentEndIndex === null) {
                alert('‚ùå Ë´ãÂÖàË®≠ÂÆö Segment Start Âíå End');
                return;
            }
            
            const start = Math.min(segmentStartIndex, segmentEndIndex);
            const end = Math.max(segmentStartIndex, segmentEndIndex);
            
            markers = markers.filter(m => m.index < start || m.index > end);
            alert(`‚úì Â∑≤Âà™Èô§ÂçÄÈñì ${start} - ${end} ÁöÑÊâÄÊúâÊ®ôË®ò`);
            calculateRRIntervals(); // ÈáçÊñ∞Ë®àÁÆó RR intervals
            drawCanvas();
        }

        function changeSegmentMarkers() {
            if (segmentStartIndex === null || segmentEndIndex === null) {
                alert('‚ùå Ë´ãÂÖàË®≠ÂÆö Segment Start Âíå End');
                return;
            }
            
            const fromType = document.getElementById('fromMarker').value;
            const toType = document.getElementById('toMarker').value;
            const start = Math.min(segmentStartIndex, segmentEndIndex);
            const end = Math.max(segmentStartIndex, segmentEndIndex);
            
            let changeCount = 0;
            markers.forEach(m => {
                if (m.index >= start && m.index <= end && m.type === fromType) {
                    m.type = toType;
                    changeCount++;
                }
            });
            
            alert(`‚úì Â∑≤Â∞á ${changeCount} ÂÄãÊ®ôË®òÂæû ${fromType} ÊîπÁÇ∫ ${toType}`);
            drawCanvas();
        }

        // ========== ANN Ê™îÊ°àËôïÁêÜÂáΩÊï∏ ==========
        function uploadANN() {
            const annFile = document.getElementById('ann-file');
            annFile.click();
        }

        // ANN Ê™îÊ°à‰∏äÂÇ≥ËôïÁêÜ
        document.addEventListener('DOMContentLoaded', function() {
            const annFileInput = document.getElementById('ann-file');
            if (annFileInput) {
                annFileInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        const annText = event.target.result;
                        parseANNFile(annText);
                        alert('‚úÖ ANN Ê™îÊ°àÂ∑≤‰∏äÂÇ≥‰∏¶Ëß£ÊûêÔºÅ');
                    };
                    reader.readAsText(file);
                });
            }
        });

        function parseANNFile(annText) {
            // Ëß£Êûê ANN Ê™îÊ°àÊ†ºÂºè (ÊôÇÈñì(ms) È°ûÂûã)
            markers = [];
            const lines = annText.trim().split('\n');
            
            for (let line of lines) {
                // ÂøΩÁï•Ë®ªËß£ÂíåÁ©∫Ë°å
                if (line.startsWith('#') || line.trim() === '') continue;
                
                const parts = line.trim().split(/\s+/);
                if (parts.length >= 2) {
                    const timeMs = parseFloat(parts[0]);
                    const markerType = parts[1];
                    
                    if (!isNaN(timeMs)) {
                        // Â∞áÊôÇÈñì(ms)ËΩâÊèõÁÇ∫ sample index
                        const sampleIndex = Math.floor(timeMs / 1000 * samplingRate);
                        
                        markers.push({
                            index: sampleIndex,
                            type: markerType
                        });
                    }
                }
            }
            
            if (canvas) {
                calculateRRIntervals(); // ÈáçÊñ∞Ë®àÁÆó RR intervalsÔºàÊúÉËá™ÂãïÊõ¥Êñ∞Áµ±Ë®àÔºâ
                drawCanvas();
            }
        }

        function predictANN() {
            // Ê®°ÂûãÈ†êÊ∏¨ÂäüËÉΩÔºàÊö´Êú™ÂØ¶‰ΩúÔºâ
            alert('‚ö†Ô∏è Ê®°ÂûãÈ†êÊ∏¨ÂäüËÉΩÈñãÁôº‰∏≠\n\nÊ≠§ÂäüËÉΩÈúÄË¶ÅÂæåÁ´Ø AI Ê®°ÂûãÊîØÊè¥ÔºåÁõÆÂâçÂÉÖ‰øùÁïô‰ªãÈù¢ÊåâÈàï„ÄÇ');
        }

        function downloadANN() {
            if (markers.length === 0) {
                alert('‚ùå Ê≤íÊúâÊ®ôË®òÂèØ‰ª•‰∏ãËºâÔºÅ\nË´ãÂÖà‰∏äÂÇ≥ ECG Ê™îÊ°à‰∏¶Ê∑ªÂä†Ê®ôË®ò„ÄÇ');
                return;
            }
            
            // ÁîüÊàê ANN Ê™îÊ°àÂÖßÂÆπ (Áµ±‰∏Ä‰ΩøÁî®ÊôÇÈñì ms Ê†ºÂºè)
            let annContent = '# ANN file format: time(ms) marker_type\n';
            markers.sort((a, b) => a.index - b.index);
            
            markers.forEach(marker => {
                const timeMs = (marker.index / samplingRate * 1000).toFixed(2);
                annContent += `${timeMs} ${marker.type}\n`;
            });
            
            // Âª∫Á´ã‰∏ãËºâ
            const blob = new Blob([annContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `ecg_${new Date().getTime()}.ANN.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert('‚úÖ ANN Ê™îÊ°àÂ∑≤‰∏ãËºâÔºÅÔºàÊ†ºÂºèÔºöÊôÇÈñìms + Ê®ôË®òÈ°ûÂûãÔºâ');
        }

        // ========== ÂÑ≤Â≠ò ECG Âà∞ FHIR ==========
        async function saveECGToFHIR() {
            try {
                if (ecgData[0].length === 0) {
                    show('ecg-result', '‚ùå Ë´ãÂÖà‰∏äÂÇ≥ ECG Ê™îÊ°à', 'error');
                    return;
                }
                
                const baseUrl = document.getElementById('baseUrl').value.trim();
                const datetime = document.getElementById('ecg-datetime').value;
                const patientId = document.getElementById('patient-id-for-ecg').value.trim();
                
                if (!datetime) {
                    show('ecg-result', '‚ùå Ë´ãÈÅ∏Êìá ECG Ë®òÈåÑÊôÇÈñì', 'error');
                    return;
                }
                
                // Âª∫Ë≠∞ÔºöÊ†πÊìö FHIR ÊúÄ‰Ω≥ÂØ¶Ë∏êÔºåObservation ÊáâË©≤ÈóúËÅØÂà∞ÁâπÂÆö Patient
                if (!patientId) {
                    const confirmed = confirm('‚ö†Ô∏è Ë≠¶ÂëäÔºöÊú™ÊåáÂÆö Patient ID\n\nÊ†πÊìö FHIR ÊúÄ‰Ω≥ÂØ¶Ë∏êÔºåObservation ÊáâË©≤ÈóúËÅØÂà∞ÁâπÂÆöÁóÖÊÇ£„ÄÇ\n\nÊòØÂê¶ÁπºÁ∫åÂª∫Á´ãÊ≤íÊúâ Patient ÈóúËÅØÁöÑ ObservationÔºü');
                    if (!confirmed) {
                        show('ecg-result', '‚ÑπÔ∏è Êìç‰ΩúÂ∑≤ÂèñÊ∂à', 'info');
                        return;
                    }
                }
                
                // Âª∫Á´ãÁ¨¶Âêà FHIR R4 Ê®ôÊ∫ñÁöÑ Observation
                const observation = {
                    resourceType: 'Observation',
                    meta: {
                        profile: ['http://hl7.org/fhir/StructureDefinition/Observation'],
                        tag: [{
                            system: 'http://hospital.example.org/ecg-tags',
                            code: 'ecg-with-annotations',
                            display: 'ECG with ANN markers'
                        }]
                    },
                    text: {
                        status: 'generated',
                        div: `<div xmlns="http://www.w3.org/1999/xhtml"><p><b>ECG Study</b></p><p>Effective: ${new Date(datetime).toLocaleString('zh-TW')}</p>${patientId ? `<p>Patient: ${patientId}</p>` : ''}<p>Components: 3-lead ECG with ${markers.length} annotations</p></div>`
                    },
                    identifier: [{
                        system: 'http://hospital.example.org/observations',  // Âª∫Ë≠∞ÔºöÊîπÁÇ∫ÂØ¶ÈöõÁöÑÈÜ´Èô¢Ë≠òÂà•Á≥ªÁµ± URI
                        value: `OBS-${Date.now()}`
                    }],
                    status: 'final',
                    category: [{
                        coding: [{
                            system: 'http://terminology.hl7.org/CodeSystem/observation-category',
                            code: 'exam',
                            display: 'Exam'
                        }],
                        text: 'Examination'
                    }],
                    code: {
                        coding: [{
                            system: 'http://loinc.org',
                            code: '11524-6',
                            display: 'EKG study'
                        }],
                        text: 'Electrocardiogram Study'
                    },
                    effectiveDateTime: new Date(datetime).toISOString(),
                    issued: new Date().toISOString(),
                    performer: [{
                        display: 'ECG Analysis System'
                    }],
                    device: {
                        display: 'Digital ECG Recorder'
                    },
                    component: []
                };
                
                // Ê∑ªÂä†ÁóÖÊÇ£ÂèÉËÄÉÔºàFHIR R4 Reference ÂÉÖÈúÄ reference Ê¨Ñ‰ΩçÔºâ
                if (patientId) {
                    observation.subject = {
                        reference: `Patient/${patientId}`
                    };
                }
                
                // Ê∑ªÂä†‰∏âÂÄãÂ∞éÁ®ãÊï∏Êìö (Á¨¶Âêà FHIR SampledData Ê†ºÂºè)
                const leadCodes = [
                    { code: '8889-8', display: 'Lead I' },
                    { code: '8890-6', display: 'Lead II' },
                    { code: '8891-4', display: 'Lead III' }
                ];
                
                for (let i = 0; i < 3; i++) {
                    // Ê™¢Êü•Êï∏ÊìöÈï∑Â∫¶ÔºåFHIR ServerÂèØËÉΩÊúâÂ§ßÂ∞èÈôêÂà∂
                    const dataString = ecgData[i].join(' ');
                    const maxDataLength = 1000000; // 1MB ÈôêÂà∂
                    
                    observation.component.push({
                        code: {
                            coding: [{
                                system: 'http://loinc.org',
                                code: leadCodes[i].code,
                                display: leadCodes[i].display
                            }],
                            text: leadCodes[i].display
                        },
                        valueSampledData: {
                            origin: {
                                value: 0,
                                unit: 'mV',
                                system: 'http://unitsofmeasure.org',
                                code: 'mV'
                            },
                            period: 1000 / samplingRate,  // ÊØ´Áßí (periodÂñÆ‰ΩçÂõ∫ÂÆöÁÇ∫ms)
                            factor: 1,
                            lowerLimit: -5,
                            upperLimit: 5,
                            dimensions: 1,
                            data: dataString.length > maxDataLength ? 
                                dataString.substring(0, maxDataLength) + '...[truncated]' : 
                                dataString
                        }
                    });
                    
                    // Â¶ÇÊûúÊï∏ÊìöË¢´Êà™Êñ∑ÔºåÊ∑ªÂä†Ë≠¶Âëä
                    if (dataString.length > maxDataLength) {
                        console.warn(`Lead ${i+1} data truncated from ${dataString.length} to ${maxDataLength} characters`);
                    }
                }
                
                // Ê∑ªÂä†Ê®ôË®ò (Annotations) - Á¨¶ÂêàFHIR AnnotationÁµêÊßã
                if (markers.length > 0) {
                    observation.note = markers.map(m => ({
                        authorString: 'ECG Analysis System',
                        time: new Date().toISOString(),
                        text: `${m.type} marker at sample ${m.index} (time: ${(m.index / samplingRate).toFixed(2)}s)`
                    }));
                    
                    // Ê†πÊìöÊ®ôË®òÈ°ûÂûãÊ∑ªÂä†interpretationÔºàQ‰πüÁÆóÁï∞Â∏∏Ôºâ
                    const hasAbnormal = markers.some(m => ['S', 'Q', 'V', 'B'].includes(m.type));
                    if (hasAbnormal) {
                        observation.interpretation = [{
                            coding: [{
                                system: 'http://terminology.hl7.org/CodeSystem/v3-ObservationInterpretation',
                                code: 'A',
                                display: 'Abnormal'
                            }],
                            text: 'Abnormal rhythm detected'
                        }];
                    } else {
                        observation.interpretation = [{
                            coding: [{
                                system: 'http://terminology.hl7.org/CodeSystem/v3-ObservationInterpretation',
                                code: 'N',
                                display: 'Normal'
                            }],
                            text: 'Normal sinus rhythm'
                        }];
                    }
                }
                
                show('ecg-result', 'Ê≠£Âú®‰∏äÂÇ≥ ECG Âà∞ FHIR Server...', 'info');
                
                const response = await fetch(`${baseUrl}/Observation`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/fhir+json',
                        'Accept': 'application/fhir+json'
                    },
                    body: JSON.stringify(observation),
                    mode: 'cors',
                    credentials: 'omit'
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    const location = response.headers.get('Location');
                    const id = data.id || (location ? location.split('/').pop() : 'unknown');
                    
                    // Âè™È°ØÁ§∫IDÔºå‰∏çÈ°ØÁ§∫ÂÆåÊï¥JSON
                    const resultDiv = document.getElementById('ecg-result');
                    resultDiv.innerHTML = `
                        <h3 style="color: #28a745;">‚úÖ ECG ÂÑ≤Â≠òÊàêÂäüÔºÅ</h3>
                        <p style="font-size: 1.2em; margin: 15px 0;">
                            <strong>Observation ID:</strong> 
                            <span style="color: #667eea; font-size: 1.3em; font-weight: bold;">${id}</span>
                        </p>
                        ${patientId ? `<p><strong>ÈóúËÅØ Patient ID:</strong> ${patientId}</p>` : ''}
                        <button onclick="copyToClipboard('${id}')" style="width: auto; padding: 10px 20px; margin: 5px;">üìã Ë§áË£Ω Observation ID</button>
                        <button onclick="loadObservationById('${id}')" style="width: auto; padding: 10px 20px; margin: 5px;">üëÅÔ∏è Êü•ÁúãÊ≠§ ECG</button>
                    `;
                    resultDiv.parentElement.style.display = 'block';
                    return;
                } else {
                    show('ecg-result', {
                        message: '‚ùå ÂÑ≤Â≠òÂ§±Êïó',
                        status: response.status,
                        error: data
                    }, 'error');
                }
            } catch (error) {
                console.error('saveECGToFHIR Ë©≥Á¥∞ÈåØË™§:', error);
                
                const resultDiv = document.getElementById('ecg-result');
                if (!resultDiv) {
                    console.error('Êâæ‰∏çÂà∞ ecg-result ÂÖÉÁ¥†');
                    return;
                }
                
                const isNetworkError = error && (error.message === 'Load failed' || error.message === 'Failed to fetch' || error.name === 'TypeError');
                
                if (isNetworkError) {
                    const baseUrl = document.getElementById('baseUrl').value.trim();
                    resultDiv.innerHTML = `
                        <div style="background: #fff3cd; border-left: 4px solid #ffc107; padding: 20px; border-radius: 8px;">
                            <h3 style="color: #856404; margin-top: 0;">‚ö†Ô∏è ÈÄ£Á∑öÂ§±Êïó</h3>
                            <p style="color: #856404; line-height: 1.8; margin: 15px 0;">
                                ÁÑ°Ê≥ïÈÄ£Êé•Âà∞ FHIR Server„ÄÇÂèØËÉΩÁöÑÂéüÂõ†Ôºö
                            </p>
                            
                            <ul style="color: #856404; line-height: 1.8;">
                                <li><strong>Á∂≤Ë∑ØÂïèÈ°åÔºö</strong>Ë´ãÊ™¢Êü•Á∂≤Ë∑ØÈÄ£Á∑ö</li>
                                <li><strong>CORS ÈôêÂà∂Ôºö</strong>FHIR Server Êú™Ê≠£Á¢∫Ë®≠ÂÆö CORS headers</li>
                                <li><strong>‰º∫ÊúçÂô®ÂïèÈ°åÔºö</strong>FHIR Server ÂèØËÉΩÊö´ÊôÇÁÑ°Ê≥ï‰ΩøÁî®</li>
                            </ul>

                            <h4 style="color: #856404; margin-top: 20px;">üí° Âª∫Ë≠∞Ôºö</h4>
                            <p style="color: #856404; margin: 10px 0;">
                                ‚úì Á¢∫Ë™ç Base URL ÊòØÂê¶Ê≠£Á¢∫<br>
                                ‚úì ÂòóË©¶Âú®ÁÄèË¶ΩÂô®Áõ¥Êé•ÈñãÂïüÔºö<br>
                                <code style="background: white; padding: 5px; border-radius: 4px; display: inline-block; margin-top: 5px;">${baseUrl}/metadata</code>
                            </p>
                            
                            <div style="margin-top: 15px;">
                                <button onclick="testFHIRConnection()" style="
                                    background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
                                    color: white;
                                    padding: 12px 24px;
                                    border: none;
                                    border-radius: 8px;
                                    cursor: pointer;
                                    font-weight: 600;
                                    box-shadow: 0 4px 12px rgba(23, 162, 184, 0.3);
                                    width: 100%;
                                ">
                                    üîç Ê∏¨Ë©¶ FHIR Server ÈÄ£Á∑ö
                                </button>
                            </div>
                        </div>
                    `;
                    resultDiv.parentElement.style.display = 'block';
                } else {
                    show('ecg-result', `‚ùå ÈåØË™§: ${error.message}`, 'error');
                }
            }
        }

        // ========== Patient È©óË≠âÂáΩÊï∏ ==========
        async function verifyAndShowOptions() {
            const patientId = document.getElementById('existing-patient-id').value.trim();
            if (!patientId) {
                alert('‚ùå Ë´ãËº∏ÂÖ• Patient ID');
                return;
            }

            try {
                const baseUrl = document.getElementById('baseUrl').value.trim();
                const response = await fetch(`${baseUrl}/Patient/${patientId}`);
                
                if (response.ok) {
                    const data = await response.json();
                    const name = data.name && data.name[0] ? `${data.name[0].given ? data.name[0].given.join(' ') : ''} ${data.name[0].family || ''}` : 'N/A';
                    
                    document.getElementById('patient-info').innerHTML = `
                        <p><strong>Patient ID:</strong> ${patientId}</p>
                        <p><strong>ÂßìÂêç:</strong> ${name}</p>
                        <p><strong>ÊÄßÂà•:</strong> ${data.gender || 'N/A'}</p>
                        <p><strong>ÁîüÊó•:</strong> ${data.birthDate || 'N/A'}</p>
                    `;
                    document.getElementById('patient-verification').style.display = 'block';
                } else {
                    alert('‚ùå Patient ID ‰∏çÂ≠òÂú®ÔºåË´ãÁ¢∫Ë™çÂæåÈáçË©¶');
                }
            } catch (error) {
                alert('‚ùå È©óË≠âÂ§±ÊïóÔºö' + error.message);
            }
        }

        // ========== ËºâÂÖ• Patient ÁöÑÊâÄÊúâ Observations ==========
        async function loadObservationsByPatient() {
            const patientId = document.getElementById('existing-patient-id').value.trim();
            const contentDiv = document.getElementById('observation-list-content');
            
            try {
                const baseUrl = document.getElementById('baseUrl').value.trim();
                contentDiv.innerHTML = '<p class="info">üîç Ê≠£Âú®Êü•Ë©¢Ê≠§ÁóÖÊÇ£ÁöÑ ECG Ë®òÈåÑ...</p>';
                
                const response = await fetch(`${baseUrl}/Observation?subject=Patient/${patientId}&code=11524-6`);
                
                if (!response.ok) {
                    contentDiv.innerHTML = '<p class="error">‚ùå Êü•Ë©¢Â§±Êïó</p>';
                    return;
                }
                
                const bundle = await response.json();
                
                if (!bundle.entry || bundle.entry.length === 0) {
                    contentDiv.innerHTML = '<p class="info">üì≠ Ê≠§ÁóÖÊÇ£Â∞öÁÑ° ECG Ë®òÈåÑ</p>';
                    return;
                }
                
                let html = '<table style="width: 100%; border-collapse: collapse;">';
                html += '<thead><tr style="background: #667eea; color: white;">';
                html += '<th style="padding: 12px; text-align: left;">Observation ID</th>';
                html += '<th style="padding: 12px; text-align: left;">Ë®òÈåÑÊôÇÈñì</th>';
                html += '<th style="padding: 12px; text-align: left;">Ê®ôË®òÊï∏Èáè</th>';
                html += '<th style="padding: 12px; text-align: center;">Êìç‰Ωú</th>';
                html += '</tr></thead><tbody>';
                
                bundle.entry.forEach(entry => {
                    const obs = entry.resource;
                    const obsId = obs.id;
                    const datetime = obs.effectiveDateTime ? new Date(obs.effectiveDateTime).toLocaleString('zh-TW') : 'N/A';
                    const markerCount = obs.note ? obs.note.length : 0;
                    
                    html += '<tr style="border-bottom: 1px solid #ddd;">';
                    html += `<td style="padding: 12px; color: #667eea; font-weight: bold;">${obsId}</td>`;
                    html += `<td style="padding: 12px;">${datetime}</td>`;
                    html += `<td style="padding: 12px;">${markerCount} ÂÄãÊ®ôË®ò</td>`;
                    html += `<td style="padding: 12px; text-align: center;">`;
                    html += `<button onclick="loadObservationById('${obsId}')" style="width: auto; padding: 8px 16px; margin: 2px; font-size: 14px;">üëÅÔ∏è Êü•Áúã/Á∑®ËºØ</button>`;
                    html += `<button onclick="copyToClipboard('${obsId}')" style="width: auto; padding: 8px 16px; margin: 2px; font-size: 14px;">üìã Ë§áË£ΩID</button>`;
                    html += '</td></tr>';
                });
                
                html += '</tbody></table>';
                html += `<p style="margin-top: 15px; color: #666;">ÂÖ±ÊâæÂà∞ ${bundle.entry.length} Á≠Ü ECG Ë®òÈåÑ</p>`;
                contentDiv.innerHTML = html;
                
            } catch (error) {
                contentDiv.innerHTML = `<p class="error">‚ùå ÈåØË™§Ôºö${error.message}</p>`;
            }
        }

        // ========== Ê†πÊìö ID ËºâÂÖ•ÂñÆ‰∏Ä Observation ==========
        async function loadObservationById(observationId) {
            try {
                const baseUrl = document.getElementById('baseUrl').value.trim();
                const response = await fetch(`${baseUrl}/Observation/${observationId}`);
                
                if (!response.ok) {
                    alert('‚ùå ÁÑ°Ê≥ïËºâÂÖ• Observation ID: ' + observationId);
                    return;
                }
                
                const obs = await response.json();
                
                // Ëß£Êûê ECG Êï∏Êìö
                if (obs.component && obs.component.length >= 3) {
                    ecgData = [[], [], []];
                    
                    for (let i = 0; i < 3; i++) {
                        const sampledData = obs.component[i].valueSampledData;
                        if (sampledData && sampledData.data) {
                            ecgData[i] = sampledData.data.split(' ').map(v => parseFloat(v));
                        }
                    }
                    
                    // Ëß£Êûê ANN Ê®ôË®ò
                    markers = [];
                    if (obs.note && obs.note.length > 0) {
                        obs.note.forEach(note => {
                            const match = note.text.match(/^(\w+) marker at sample (\d+)/);
                            if (match) {
                                markers.push({
                                    type: match[1],
                                    index: parseInt(match[2])
                                });
                            }
                        });
                    }
                    
                    // Â°´ÂÖ•Áõ∏ÈóúË≥áË®ä
                    if (obs.effectiveDateTime) {
                        const dt = new Date(obs.effectiveDateTime);
                        dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
                        document.getElementById('ecg-datetime').value = dt.toISOString().slice(0, 16);
                    }
                    
                    if (obs.subject && obs.subject.reference) {
                        const patientId = obs.subject.reference.split('/').pop();
                        document.getElementById('patient-id-for-ecg').value = patientId;
                    }
                    
                    // È°ØÁ§∫ ECG Áï´Èù¢
                    showECGView();
                    
                    // ÂàùÂßãÂåñ Canvas
                    currentStartIndex = 0;
                    canvas = document.getElementById('dataCanvas');
                    ctx = canvas.getContext('2d');
                    zoomCanvas = document.getElementById('zoomCanvas');
                    zoomCtx = zoomCanvas.getContext('2d');
                    progressBar = document.getElementById('progress-bar');
                    progressHandle = document.getElementById('progress-handle');
                    
                    document.getElementById('ecg-canvas-area').style.display = 'block';
                    
                    calculateRRIntervals();
                    drawCanvas();
                    drawZoomCanvas();
                    updateProgressBar();
                    setupCanvasEvents();
                    
                    alert(`‚úÖ Â∑≤ËºâÂÖ• Observation ID: ${observationId}\nÂåÖÂê´ ${ecgData[0].length} ÂÄãÊ®£Êú¨ÈªûÂíå ${markers.length} ÂÄãÊ®ôË®ò\n\nÊÇ®ÂèØ‰ª•Á∑®ËºØ ANN Ê®ôË®òÂæåÈáçÊñ∞ÂÑ≤Â≠ò`);
                } else {
                    alert('‚ùå Ê≠§ Observation Ê≤íÊúâÊúâÊïàÁöÑ ECG Êï∏Êìö');
                }
                
            } catch (error) {
                alert('‚ùå ËºâÂÖ•Â§±ÊïóÔºö' + error.message);
            }
        }

        // ========== Ë°®ÂñÆÊèê‰∫§ËôïÁêÜ ==========
        document.getElementById('patientForm').addEventListener('submit', function(e) {
            e.preventDefault();
            createPatient();
        });

        // ========== ÂàùÂßãÂåñ ==========
        // ========== Êñ∞ÊâãÂºïÂ∞éÁ≥ªÁµ± ==========
        function showTutorial() {
            const overlay = document.createElement('div');
            overlay.className = 'tutorial-overlay';
            overlay.innerHTML = `
                <div class="tutorial-box">
                    <h2>üéì Ê≠°Ëøé‰ΩøÁî® FHIR ECG ÁÆ°ÁêÜÁ≥ªÁµ±</h2>
                    <h3 style="margin-top: 20px; color: #333;">üìã Âø´ÈÄüÈñãÂßã</h3>
                    <ul>
                        <li>‚úÖ <strong>Ê≠•È©ü 1Ôºö</strong>Âª∫Á´ãÊñ∞ÁóÖÊÇ£Êàñ‰ΩøÁî®Â∑≤ÊúâÁóÖÊÇ£</li>
                        <li>‚úÖ <strong>Ê≠•È©ü 2Ôºö</strong>‰∏äÂÇ≥ ECG Ê™îÊ°àÔºà.txt Ê†ºÂºèÔºâ</li>
                        <li>‚úÖ <strong>Ê≠•È©ü 3Ôºö</strong>Ê∑ªÂä† ANN Ê®ôË®òÔºàN/S/Q/V/BÔºâ</li>
                        <li>‚úÖ <strong>Ê≠•È©ü 4Ôºö</strong>ÂÑ≤Â≠òÂà∞ FHIR Server</li>
                    </ul>
                    
                    <h3 style="margin-top: 20px; color: #333;">‚å®Ô∏è ÈçµÁõ§Âø´Êç∑Èçµ</h3>
                    <ul>
                        <li><span class="shortcut">N</span> NormalÔºàÊ≠£Â∏∏ÂøÉË∑≥Ôºâ</li>
                        <li><span class="shortcut">S</span> SupraventricularÔºàÂÆ§‰∏äÊÄßÔºâ</li>
                        <li><span class="shortcut">Q</span> UnclassifiedÔºàÊú™ÂàÜÈ°ûÔºâ</li>
                        <li><span class="shortcut">V</span> VentricularÔºàÂøÉÂÆ§ÊÄßÔºâ</li>
                        <li><span class="shortcut">B</span> Bundle branch blockÔºàÊùüÊîØÂÇ≥Â∞éÈòªÊªØÔºâ</li>
                        <li><span class="shortcut">Del</span> Âà™Èô§Ê®°Âºè</li>
                        <li><span class="shortcut">‚Üê</span> <span class="shortcut">‚Üí</span> Â∑¶Âè≥ÁßªÂãï ECG È°ØÁ§∫</li>
                        <li><span class="shortcut">?</span> È°ØÁ§∫Âø´Êç∑ÈçµÊèêÁ§∫</li>
                    </ul>
                    
                    <h3 style="margin-top: 20px; color: #333;">üñ±Ô∏è ÊªëÈº†Êìç‰Ωú</h3>
                    <ul>
                        <li><strong>Â∑¶ÈçµÈªûÊìäÔºö</strong>Ê∑ªÂä†/‰øÆÊîπ/Âà™Èô§Ê®ôË®òÔºàÊô∫ËÉΩÊ®°ÂºèÔºâ</li>
                        <li><strong>Âè≥ÈçµÈªûÊìäÔºö</strong>ÈñãÂïüÂø´ÈÄüÈÅ∏ÂñÆ</li>
                        <li><strong>Âè≥Èçµ RR ÂúñÔºö</strong>ÂàáÊèõÊîæÂ§ßÁ¥öÂà•Ôºà1ÂàÜÈêò/30Áßí/10ÁßíÔºâ</li>
                        <li><strong>ÊãñÂãï RR ÂúñÔºö</strong>ÁßªÂãïÊîæÂ§ßË¶ñÂúñ</li>
                    </ul>
                    
                    <div style="margin-top: 30px; text-align: center;">
                        <button onclick="closeTutorial()" style="padding: 12px 30px; font-size: 1.1em; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);">
                            ÈñãÂßã‰ΩøÁî® üöÄ
                        </button>
                        <p style="margin-top: 15px; color: #999; font-size: 0.9em;">
                            <label><input type="checkbox" id="dontShowAgain" style="margin-right: 5px;"> ‰∏çÂÜçÈ°ØÁ§∫Ê≠§ÊïôÂ≠∏</label>
                        </p>
                    </div>
                </div>
            `;
            document.body.appendChild(overlay);
        }

        function closeTutorial() {
            const dontShow = document.getElementById('dontShowAgain').checked;
            if (dontShow) {
                localStorage.setItem('hideTutorial', 'true');
            }
            document.querySelector('.tutorial-overlay').remove();
        }

        // ========== ÈçµÁõ§Âø´Êç∑ÈçµÁ≥ªÁµ± ==========
        let shortcutHintVisible = false;

        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', function(e) {
                // Â¶ÇÊûúÂú®Ëº∏ÂÖ•Ê°Ü‰∏≠Ôºå‰∏çËß∏ÁôºÂø´Êç∑Èçµ
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
                    return;
                }

                const key = e.key.toLowerCase();
                
                // Ê®ôË®òÈ°ûÂûãÂø´Êç∑Èçµ
                if (key === 'n') {
                    e.preventDefault();
                    document.getElementById('btn1').click();
                    showKeyHint('Â∑≤ÈÅ∏Êìá: Normal (N)');
                } else if (key === 's') {
                    e.preventDefault();
                    document.getElementById('btn2').click();
                    showKeyHint('Â∑≤ÈÅ∏Êìá: Supraventricular (S)');
                } else if (key === 'q') {
                    e.preventDefault();
                    document.getElementById('btn3').click();
                    showKeyHint('Â∑≤ÈÅ∏Êìá: Unclassified (Q)');
                } else if (key === 'v') {
                    e.preventDefault();
                    document.getElementById('btn4').click();
                    showKeyHint('Â∑≤ÈÅ∏Êìá: Ventricular (V)');
                } else if (key === 'b') {
                    e.preventDefault();
                    document.getElementById('btn5').click();
                    showKeyHint('Â∑≤ÈÅ∏Êìá: Bundle branch block (B)');
                } else if (key === 'delete' || key === 'backspace') {
                    if (e.target.tagName !== 'INPUT') {
                        e.preventDefault();
                        document.getElementById('btnDelete').click();
                        showKeyHint('Â∑≤ÈÅ∏Êìá: Âà™Èô§Ê®°Âºè');
                    }
                } else if (key === '?' || (e.shiftKey && key === '/')) {
                    e.preventDefault();
                    toggleShortcutHint();
                }
            });
        }

        function showKeyHint(message) {
            // ÁßªÈô§ËàäÊèêÁ§∫
            const oldHint = document.getElementById('key-hint-notification');
            if (oldHint) oldHint.remove();

            // ÂâµÂª∫Êñ∞ÊèêÁ§∫
            const hint = document.createElement('div');
            hint.id = 'key-hint-notification';
            hint.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 12px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
                z-index: 10000;
                font-size: 14px;
                font-weight: 600;
                animation: slideInRight 0.3s ease, fadeOut 0.3s ease 1.7s;
            `;
            hint.textContent = message;
            document.body.appendChild(hint);

            setTimeout(() => hint.remove(), 2000);
        }

        function toggleShortcutHint() {
            let hint = document.getElementById('shortcut-hint-box');
            
            if (hint) {
                hint.remove();
                shortcutHintVisible = false;
            } else {
                hint = document.createElement('div');
                hint.id = 'shortcut-hint-box';
                hint.className = 'shortcut-hint';
                hint.innerHTML = `
                    <h4>‚å®Ô∏è ÈçµÁõ§Âø´Êç∑Èçµ</h4>
                    <p><strong>N/S/Q/V/B</strong> - ÈÅ∏ÊìáÊ®ôË®òÈ°ûÂûã</p>
                    <p><strong>Del</strong> - Âà™Èô§Ê®°Âºè</p>
                    <p><strong>‚Üê ‚Üí</strong> - ÁßªÂãï ECG</p>
                    <p><strong>?</strong> - È°ØÁ§∫/Èö±ËóèÊ≠§ÊèêÁ§∫</p>
                    <p style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; color: #999; font-size: 0.85em;">ÈªûÊìä‰ªªÊÑèËôïÈóúÈñâ</p>
                `;
                document.body.appendChild(hint);
                shortcutHintVisible = true;

                // ÈªûÊìäÈóúÈñâ
                hint.addEventListener('click', () => {
                    hint.remove();
                    shortcutHintVisible = false;
                });
            }
        }

        // ========== Âè≥ÈçµÈÅ∏ÂñÆÁ≥ªÁµ± ==========
        let contextMenu = null;
        let contextMenuMarkerIndex = null;

        function setupContextMenu() {
            // Âú® Canvas ‰∏äÂè≥Èçµ
            const canvas = document.getElementById('dataCanvas');
            if (canvas) {
                canvas.addEventListener('contextmenu', function(e) {
                    e.preventDefault();
                    
                    const rect = canvas.getBoundingClientRect();
                    const clickX = e.clientX - rect.left;
                    const scaleX = canvas.width / rect.width;
                    const canvasX = clickX * scaleX;
                    const visibleSamples = samplingRate * visibleGrids;
                    const clickIndex = currentStartIndex + Math.round((canvasX / canvas.width) * visibleSamples);
                    
                    // Ê™¢Êü•ÊòØÂê¶ÈªûÊìäÂú®Ê®ôË®ò‰∏ä
                    const nearbyMarker = markers.find(m => Math.abs(m.index - clickIndex) <= 5);
                    
                    if (nearbyMarker) {
                        showContextMenu(e.clientX, e.clientY, nearbyMarker, clickIndex);
                    } else {
                        showContextMenu(e.clientX, e.clientY, null, clickIndex);
                    }
                });
            }

            // ÈªûÊìäÂÖ∂‰ªñÂú∞ÊñπÈóúÈñâÈÅ∏ÂñÆ
            document.addEventListener('click', function() {
                if (contextMenu) {
                    contextMenu.remove();
                    contextMenu = null;
                }
            });
        }

        function showContextMenu(x, y, marker, clickIndex) {
            // ÁßªÈô§ËàäÈÅ∏ÂñÆ
            if (contextMenu) contextMenu.remove();

            contextMenu = document.createElement('div');
            contextMenu.className = 'context-menu';
            contextMenu.style.left = x + 'px';
            contextMenu.style.top = y + 'px';

            if (marker) {
                // ÊúâÊ®ôË®òÔºöÈ°ØÁ§∫‰øÆÊîπÂíåÂà™Èô§ÈÅ∏È†Ö
                contextMenu.innerHTML = `
                    <div class="context-menu-item" onclick="changeMarkerType(${marker.index}, 'N')">üìå ÊîπÁÇ∫ Normal (N)</div>
                    <div class="context-menu-item" onclick="changeMarkerType(${marker.index}, 'S')">üìå ÊîπÁÇ∫ Supraventricular (S)</div>
                    <div class="context-menu-item" onclick="changeMarkerType(${marker.index}, 'Q')">üìå ÊîπÁÇ∫ Unclassified (Q)</div>
                    <div class="context-menu-item" onclick="changeMarkerType(${marker.index}, 'V')">üìå ÊîπÁÇ∫ Ventricular (V)</div>
                    <div class="context-menu-item" onclick="changeMarkerType(${marker.index}, 'B')">üìå ÊîπÁÇ∫ Bundle branch block (B)</div>
                    <div class="context-menu-item danger" onclick="deleteMarkerAt(${marker.index})">üóëÔ∏è Âà™Èô§Ê®ôË®ò</div>
                `;
            } else {
                // ÁÑ°Ê®ôË®òÔºöÈ°ØÁ§∫Êñ∞Â¢ûÈÅ∏È†Ö
                contextMenu.innerHTML = `
                    <div class="context-menu-item" onclick="addMarkerAt(${clickIndex}, 'N')">‚ûï Êñ∞Â¢û Normal (N)</div>
                    <div class="context-menu-item" onclick="addMarkerAt(${clickIndex}, 'S')">‚ûï Êñ∞Â¢û Supraventricular (S)</div>
                    <div class="context-menu-item" onclick="addMarkerAt(${clickIndex}, 'Q')">‚ûï Êñ∞Â¢û Unclassified (Q)</div>
                    <div class="context-menu-item" onclick="addMarkerAt(${clickIndex}, 'V')">‚ûï Êñ∞Â¢û Ventricular (V)</div>
                    <div class="context-menu-item" onclick="addMarkerAt(${clickIndex}, 'B')">‚ûï Êñ∞Â¢û Bundle branch block (B)</div>
                `;
            }

            document.body.appendChild(contextMenu);
        }

        function changeMarkerType(markerIndex, newType) {
            const marker = markers.find(m => m.index === markerIndex);
            if (marker) {
                marker.type = newType;
                calculateRRIntervals();
                drawCanvas();
            }
            if (contextMenu) contextMenu.remove();
        }

        function deleteMarkerAt(markerIndex) {
            markers = markers.filter(m => m.index !== markerIndex);
            calculateRRIntervals();
            drawCanvas();
            if (contextMenu) contextMenu.remove();
        }

        function addMarkerAt(clickIndex, type) {
            markers.push({ index: clickIndex, type: type });
            calculateRRIntervals();
            drawCanvas();
            if (contextMenu) contextMenu.remove();
        }

        window.onload = function() {
            // Ë®≠ÂÆöÊó•ÊúüÊôÇÈñìÈªòË™çÂÄºÁÇ∫ÁèæÂú®
            const now = new Date();
            now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
            document.getElementById('ecg-datetime').value = now.toISOString().slice(0, 16);

            // ÂàùÂßãÂåñÈçµÁõ§Âø´Êç∑Èçµ
            setupKeyboardShortcuts();

            // ÂàùÂßãÂåñÂè≥ÈçµÈÅ∏ÂñÆ
            setupContextMenu();

            // Ê™¢Êü•ÊòØÂê¶È°ØÁ§∫Êñ∞ÊâãÂºïÂ∞é
            const hideTutorial = localStorage.getItem('hideTutorial');
            if (!hideTutorial) {
                setTimeout(showTutorial, 500);
            }
        };
    </script>
</body>
</html>